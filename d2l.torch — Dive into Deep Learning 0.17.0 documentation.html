<!DOCTYPE html>
<!-- saved from url=(0038)https://d2l.ai/_modules/d2l/torch.html -->
<html class="mdl-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <title>d2l.torch — Dive into Deep Learning 0.17.0 documentation</title>

    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/pygments.css" type="text/css">
    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/basic.css" type="text/css">
    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/material.blue-deep_orange.min.css" type="text/css">
    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/sphinx_materialdesign_theme.css" type="text/css">
    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/all.css" type="text/css">
    <link rel="stylesheet" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/fonts.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/d2l.css">
    <script async="" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/analytics.js.download"></script><script id="documentation_options" data-url_root="../../" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/documentation_options.js.download"></script>
    <script src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/jquery.js.download"></script>
    <script src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/underscore.js.download"></script>
    <script src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/doctools.js.download"></script>
    <script src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/d2l.js.download"></script>
    
    <link rel="shortcut icon" href="https://d2l.ai/_static/favicon.png">
    <link rel="index" title="Index" href="https://d2l.ai/genindex.html">
    <link rel="search" title="Search" href="https://d2l.ai/search.html"> 
  <script type="text/javascript" async="" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/MathJax.js.download"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover, .MJXp-munder {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > *, .MJXp-munder > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>
<body style="display: block;" class="vsc-initialized"><div id="MathJax_Message" style="display: none;"></div>
    <div class="mdl-layout__container"><div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer has-drawer is-upgraded" data-upgraded=",MaterialLayout"><header class="mdl-layout__header mdl-layout__header--waterfall is-casting-shadow is-compact"><div aria-expanded="false" role="button" tabindex="0" class="mdl-layout__drawer-button"><i class="material-icons"></i></div>
    <div class="mdl-layout__header-row">
        
        <nav class="mdl-navigation breadcrumb">
            <a class="mdl-navigation__link" href="https://d2l.ai/_modules/index.html">Module code</a><i class="material-icons">navigate_next</i>
            <a class="mdl-navigation__link is-active">d2l.torch</a>
        </nav>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
        
<form class="form-inline pull-sm-right" action="https://d2l.ai/search.html" method="get">
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right has-placeholder is-upgraded" data-upgraded=",MaterialTextfield">
        <label id="quick-search-icon" class="mdl-button mdl-js-button mdl-button--icon" for="waterfall-exp" data-upgraded=",MaterialButton" tabindex="0">
          <i class="material-icons">search</i>
        </label>
        <div class="mdl-textfield__expandable-holder">
          <input class="mdl-textfield__input" type="text" name="q" id="waterfall-exp" placeholder="Search">
          <input type="hidden" name="check_keywords" value="yes">
          <input type="hidden" name="area" value="default">
        </div>
      </div>
      <div class="mdl-tooltip" data-mdl-for="quick-search-icon" data-upgraded=",MaterialTooltip">
      Quick search
      </div>
</form>
        
        </nav>
    </div>
    <div class="mdl-layout__header-row header-links">
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
          
              <a class="mdl-navigation__link" href="https://d2l.ai/d2l-en.pdf">
                  <i class="fas fa-file-pdf"></i>
                  MXNet
              </a>
          
              <a class="mdl-navigation__link" href="https://d2l.ai/d2l-en-pytorch.pdf">
                  <i class="fas fa-file-pdf"></i>
                  PyTorch
              </a>
          
              <a class="mdl-navigation__link" href="https://d2l.ai/d2l-en.zip">
                  <i class="fas fa-download"></i>
                  Notebooks
              </a>
          
              <a class="mdl-navigation__link" href="https://courses.d2l.ai/">
                  <i class="fas fa-user-graduate"></i>
                  Courses
              </a>
          
              <a class="mdl-navigation__link" href="https://github.com/d2l-ai/d2l-en">
                  <i class="fab fa-github"></i>
                  GitHub
              </a>
          
              <a class="mdl-navigation__link" href="https://zh.d2l.ai/">
                  <i class="fas fa-external-link-alt"></i>
                  中文版
              </a>
      </nav>
    </div>
</header><header class="mdl-layout__drawer" aria-hidden="true">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="https://d2l.ai/index.html">
              <img class="logo" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/logo-with-text.png" alt="Dive into Deep Learning">
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preface/index.html">Preface</a></span></li>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_installation/index.html">Installation</a></span></li>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_notation/index.html">Notation</a></span></li>
</ul>
<ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_introduction/index.html">1. Introduction</a></span></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/index.html">2. Preliminaries</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-4" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-4" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/ndarray.html">2.1. Data Manipulation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/pandas.html">2.2. Data Preprocessing</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/linear-algebra.html">2.3. Linear Algebra</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/calculus.html">2.4. Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/autograd.html">2.5. Automatic Differentiation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/probability.html">2.6. Probability</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/lookup-api.html">2.7. Documentation</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/index.html">3. Linear Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-12" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-12" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression.html">3.1. Linear Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression-scratch.html">3.2. Linear Regression Implementation from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression-concise.html">3.3. Concise Implementation of Linear Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression.html">3.4. Softmax Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/image-classification-dataset.html">3.5. The Image Classification Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression-scratch.html">3.6. Implementation of Softmax Regression from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression-concise.html">3.7. Concise Implementation of Softmax Regression</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/index.html">4. Multilayer Perceptrons</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-20" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-20" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp.html">4.1. Multilayer Perceptrons</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp-scratch.html">4.2. Implementation of Multilayer Perceptrons from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp-concise.html">4.3. Concise Implementation of Multilayer Perceptrons</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/underfit-overfit.html">4.4. Model Selection, Underfitting, and Overfitting</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/weight-decay.html">4.5. Weight Decay</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/dropout.html">4.6. Dropout</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/backprop.html">4.7. Forward Propagation, Backward Propagation, and Computational Graphs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/numerical-stability-and-init.html">4.8. Numerical Stability and Initialization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/environment.html">4.9. Environment and Distribution Shift</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/kaggle-house-price.html">4.10. Predicting House Prices on Kaggle</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/index.html">5. Deep Learning Computation</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-31" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-31" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/model-construction.html">5.1. Layers and Blocks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/parameters.html">5.2. Parameter Management</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/deferred-init.html">5.3. Deferred Initialization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/custom-layer.html">5.4. Custom Layers</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/read-write.html">5.5. File I/O</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/use-gpu.html">5.6. GPUs</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/index.html">6. Convolutional Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-38" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-38" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/why-conv.html">6.1. From Fully-Connected Layers to Convolutions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/conv-layer.html">6.2. Convolutions for Images</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/padding-and-strides.html">6.3. Padding and Stride</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/channels.html">6.4. Multiple Input and Multiple Output Channels</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/pooling.html">6.5. Pooling</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/lenet.html">6.6. Convolutional Neural Networks (LeNet)</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/index.html">7. Modern Convolutional Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-45" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-45" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/alexnet.html">7.1. Deep Convolutional Neural Networks (AlexNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/vgg.html">7.2. Networks Using Blocks (VGG)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/nin.html">7.3. Network in Network (NiN)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/googlenet.html">7.4. Networks with Parallel Concatenations (GoogLeNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/batch-norm.html">7.5. Batch Normalization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/resnet.html">7.6. Residual Networks (ResNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/densenet.html">7.7. Densely Connected Networks (DenseNet)</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/index.html">8. Recurrent Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-53" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-53" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/sequence.html">8.1. Sequence Models</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/text-preprocessing.html">8.2. Text Preprocessing</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/language-models-and-dataset.html">8.3. Language Models and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn.html">8.4. Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn-scratch.html">8.5. Implementation of Recurrent Neural Networks from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn-concise.html">8.6. Concise Implementation of Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/bptt.html">8.7. Backpropagation Through Time</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/index.html">9. Modern Recurrent Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-61" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-61" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/gru.html">9.1. Gated Recurrent Units (GRU)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/lstm.html">9.2. Long Short-Term Memory (LSTM)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/deep-rnn.html">9.3. Deep Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/bi-rnn.html">9.4. Bidirectional Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/machine-translation-and-dataset.html">9.5. Machine Translation and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/encoder-decoder.html">9.6. Encoder-Decoder Architecture</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/seq2seq.html">9.7. Sequence to Sequence Learning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/beam-search.html">9.8. Beam Search</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/index.html">10. Attention Mechanisms</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-70" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-70" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/attention-cues.html">10.1. Attention Cues</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/nadaraya-watson.html">10.2. Attention Pooling: Nadaraya-Watson Kernel Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/attention-scoring-functions.html">10.3. Attention Scoring Functions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/bahdanau-attention.html">10.4. Bahdanau Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/multihead-attention.html">10.5. Multi-Head Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/self-attention-and-positional-encoding.html">10.6. Self-Attention and Positional Encoding</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/transformer.html">10.7. Transformer</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/index.html">11. Optimization Algorithms</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-78" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-78" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/optimization-intro.html">11.1. Optimization and Deep Learning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/convexity.html">11.2. Convexity</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/gd.html">11.3. Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/sgd.html">11.4. Stochastic Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/minibatch-sgd.html">11.5. Minibatch Stochastic Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/momentum.html">11.6. Momentum</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adagrad.html">11.7. Adagrad</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/rmsprop.html">11.8. RMSProp</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adadelta.html">11.9. Adadelta</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adam.html">11.10. Adam</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/lr-scheduler.html">11.11. Learning Rate Scheduling</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/index.html">12. Computational Performance</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-90" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-90" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/hybridize.html">12.1. Compilers and Interpreters</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/async-computation.html">12.2. Asynchronous Computation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/auto-parallelism.html">12.3. Automatic Parallelism</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/hardware.html">12.4. Hardware</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/multiple-gpus.html">12.5. Training on Multiple GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/multiple-gpus-concise.html">12.6. Concise Implementation for Multiple GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/parameterserver.html">12.7. Parameter Servers</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/index.html">13. Computer Vision</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-98" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-98" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/image-augmentation.html">13.1. Image Augmentation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/fine-tuning.html">13.2. Fine-Tuning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/bounding-box.html">13.3. Object Detection and Bounding Boxes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/anchor.html">13.4. Anchor Boxes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/multiscale-object-detection.html">13.5. Multiscale Object Detection</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/object-detection-dataset.html">13.6. The Object Detection Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/ssd.html">13.7. Single Shot Multibox Detection</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/rcnn.html">13.8. Region-based CNNs (R-CNNs)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/semantic-segmentation-and-dataset.html">13.9. Semantic Segmentation and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/transposed-conv.html">13.10. Transposed Convolution</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/fcn.html">13.11. Fully Convolutional Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/neural-style.html">13.12. Neural Style Transfer</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/kaggle-cifar10.html">13.13. Image Classification (CIFAR-10) on Kaggle</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/kaggle-dog.html">13.14. Dog Breed Identification (ImageNet Dogs) on Kaggle</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/index.html">14. Natural Language Processing: Pretraining</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-113" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-113" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word2vec.html">14.1. Word Embedding (word2vec)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/approx-training.html">14.2. Approximate Training</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word-embedding-dataset.html">14.3. The Dataset for Pretraining Word Embeddings</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word2vec-pretraining.html">14.4. Pretraining word2vec</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/glove.html">14.5. Word Embedding with Global Vectors (GloVe)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/subword-embedding.html">14.6. Subword Embedding</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/similarity-analogy.html">14.7. Word Similarity and Analogy</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert.html">14.8. Bidirectional Encoder Representations from Transformers (BERT)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert-dataset.html">14.9. The Dataset for Pretraining BERT</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert-pretraining.html">14.10. Pretraining BERT</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/index.html">15. Natural Language Processing: Applications</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-124" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-124" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-and-dataset.html">15.1. Sentiment Analysis and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-rnn.html">15.2. Sentiment Analysis: Using Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-cnn.html">15.3. Sentiment Analysis: Using Convolutional Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-and-dataset.html">15.4. Natural Language Inference and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-attention.html">15.5. Natural Language Inference: Using Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/finetuning-bert.html">15.6. Fine-Tuning BERT for Sequence-Level and Token-Level Applications</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-bert.html">15.7. Natural Language Inference: Fine-Tuning BERT</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/index.html">16. Recommender Systems</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-132" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-132" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/recsys-intro.html">16.1. Overview of Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/movielens.html">16.2. The MovieLens Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/mf.html">16.3. Matrix Factorization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/autorec.html">16.4. AutoRec: Rating Prediction with Autoencoders</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/ranking.html">16.5. Personalized Ranking for Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/neumf.html">16.6. Neural Collaborative Filtering for Personalized Ranking</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/seqrec.html">16.7. Sequence-Aware Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/ctr.html">16.8. Feature-Rich Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/fm.html">16.9. Factorization Machines</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/deepfm.html">16.10. Deep Factorization Machines</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/index.html">17. Generative Adversarial Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-143" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-143" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/gan.html">17.1. Generative Adversarial Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/dcgan.html">17.2. Deep Convolutional Generative Adversarial Networks</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/index.html">18. Appendix: Mathematics for Deep Learning</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-146" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-146" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/geometry-linear-algebraic-ops.html">18.1. Geometry and Linear Algebraic Operations</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/eigendecomposition.html">18.2. Eigendecompositions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/single-variable-calculus.html">18.3. Single Variable Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/multivariable-calculus.html">18.4. Multivariable Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/integral-calculus.html">18.5. Integral Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/random-variables.html">18.6. Random Variables</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/maximum-likelihood.html">18.7. Maximum Likelihood</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/distributions.html">18.8. Distributions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/naive-bayes.html">18.9. Naive Bayes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/statistics.html">18.10. Statistics</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/information-theory.html">18.11. Information Theory</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/index.html">19. Appendix: Tools for Deep Learning</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-158" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-158" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/jupyter.html">19.1. Using Jupyter</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/sagemaker.html">19.2. Using Amazon SageMaker</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/aws.html">19.3. Using AWS EC2 Instances</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/colab.html">19.4. Using Google Colab</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/selecting-servers-gpus.html">19.5. Selecting Servers and GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/contributing.html">19.6. Contributing to This Book</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html">19.7. <code class="docutils literal notranslate"><span class="pre">d2l</span></code> API Document</a></span></li>
</ul></li>
</ul>
<ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_references/zreferences.html">References</a></span></li>
</ul>

            </nav>
        
        </div>
    
</header>
        <main class="mdl-layout__content" tabindex="0">

	<script type="text/javascript" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/sphinx_materialdesign_theme.js.download"></script>
    <header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="https://d2l.ai/index.html">
              <img class="logo" src="./d2l.torch — Dive into Deep Learning 0.17.0 documentation_files/logo-with-text.png" alt="Dive into Deep Learning">
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preface/index.html">Preface</a></span></li>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_installation/index.html">Installation</a></span></li>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_notation/index.html">Notation</a></span></li>
</ul>
<ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_introduction/index.html">1. Introduction</a></span></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/index.html">2. Preliminaries</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-171" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-171" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/ndarray.html">2.1. Data Manipulation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/pandas.html">2.2. Data Preprocessing</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/linear-algebra.html">2.3. Linear Algebra</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/calculus.html">2.4. Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/autograd.html">2.5. Automatic Differentiation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/probability.html">2.6. Probability</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_preliminaries/lookup-api.html">2.7. Documentation</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/index.html">3. Linear Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-179" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-179" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression.html">3.1. Linear Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression-scratch.html">3.2. Linear Regression Implementation from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/linear-regression-concise.html">3.3. Concise Implementation of Linear Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression.html">3.4. Softmax Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/image-classification-dataset.html">3.5. The Image Classification Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression-scratch.html">3.6. Implementation of Softmax Regression from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_linear-networks/softmax-regression-concise.html">3.7. Concise Implementation of Softmax Regression</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/index.html">4. Multilayer Perceptrons</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-187" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-187" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp.html">4.1. Multilayer Perceptrons</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp-scratch.html">4.2. Implementation of Multilayer Perceptrons from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/mlp-concise.html">4.3. Concise Implementation of Multilayer Perceptrons</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/underfit-overfit.html">4.4. Model Selection, Underfitting, and Overfitting</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/weight-decay.html">4.5. Weight Decay</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/dropout.html">4.6. Dropout</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/backprop.html">4.7. Forward Propagation, Backward Propagation, and Computational Graphs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/numerical-stability-and-init.html">4.8. Numerical Stability and Initialization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/environment.html">4.9. Environment and Distribution Shift</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_multilayer-perceptrons/kaggle-house-price.html">4.10. Predicting House Prices on Kaggle</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/index.html">5. Deep Learning Computation</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-198" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-198" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/model-construction.html">5.1. Layers and Blocks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/parameters.html">5.2. Parameter Management</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/deferred-init.html">5.3. Deferred Initialization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/custom-layer.html">5.4. Custom Layers</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/read-write.html">5.5. File I/O</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_deep-learning-computation/use-gpu.html">5.6. GPUs</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/index.html">6. Convolutional Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-205" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-205" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/why-conv.html">6.1. From Fully-Connected Layers to Convolutions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/conv-layer.html">6.2. Convolutions for Images</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/padding-and-strides.html">6.3. Padding and Stride</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/channels.html">6.4. Multiple Input and Multiple Output Channels</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/pooling.html">6.5. Pooling</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-neural-networks/lenet.html">6.6. Convolutional Neural Networks (LeNet)</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/index.html">7. Modern Convolutional Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-212" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-212" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/alexnet.html">7.1. Deep Convolutional Neural Networks (AlexNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/vgg.html">7.2. Networks Using Blocks (VGG)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/nin.html">7.3. Network in Network (NiN)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/googlenet.html">7.4. Networks with Parallel Concatenations (GoogLeNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/batch-norm.html">7.5. Batch Normalization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/resnet.html">7.6. Residual Networks (ResNet)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_convolutional-modern/densenet.html">7.7. Densely Connected Networks (DenseNet)</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/index.html">8. Recurrent Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-220" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-220" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/sequence.html">8.1. Sequence Models</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/text-preprocessing.html">8.2. Text Preprocessing</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/language-models-and-dataset.html">8.3. Language Models and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn.html">8.4. Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn-scratch.html">8.5. Implementation of Recurrent Neural Networks from Scratch</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/rnn-concise.html">8.6. Concise Implementation of Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-neural-networks/bptt.html">8.7. Backpropagation Through Time</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/index.html">9. Modern Recurrent Neural Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-228" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-228" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/gru.html">9.1. Gated Recurrent Units (GRU)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/lstm.html">9.2. Long Short-Term Memory (LSTM)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/deep-rnn.html">9.3. Deep Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/bi-rnn.html">9.4. Bidirectional Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/machine-translation-and-dataset.html">9.5. Machine Translation and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/encoder-decoder.html">9.6. Encoder-Decoder Architecture</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/seq2seq.html">9.7. Sequence to Sequence Learning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recurrent-modern/beam-search.html">9.8. Beam Search</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/index.html">10. Attention Mechanisms</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-237" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-237" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/attention-cues.html">10.1. Attention Cues</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/nadaraya-watson.html">10.2. Attention Pooling: Nadaraya-Watson Kernel Regression</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/attention-scoring-functions.html">10.3. Attention Scoring Functions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/bahdanau-attention.html">10.4. Bahdanau Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/multihead-attention.html">10.5. Multi-Head Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/self-attention-and-positional-encoding.html">10.6. Self-Attention and Positional Encoding</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_attention-mechanisms/transformer.html">10.7. Transformer</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/index.html">11. Optimization Algorithms</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-245" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-245" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/optimization-intro.html">11.1. Optimization and Deep Learning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/convexity.html">11.2. Convexity</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/gd.html">11.3. Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/sgd.html">11.4. Stochastic Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/minibatch-sgd.html">11.5. Minibatch Stochastic Gradient Descent</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/momentum.html">11.6. Momentum</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adagrad.html">11.7. Adagrad</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/rmsprop.html">11.8. RMSProp</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adadelta.html">11.9. Adadelta</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/adam.html">11.10. Adam</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_optimization/lr-scheduler.html">11.11. Learning Rate Scheduling</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/index.html">12. Computational Performance</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-257" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-257" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/hybridize.html">12.1. Compilers and Interpreters</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/async-computation.html">12.2. Asynchronous Computation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/auto-parallelism.html">12.3. Automatic Parallelism</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/hardware.html">12.4. Hardware</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/multiple-gpus.html">12.5. Training on Multiple GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/multiple-gpus-concise.html">12.6. Concise Implementation for Multiple GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computational-performance/parameterserver.html">12.7. Parameter Servers</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/index.html">13. Computer Vision</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-265" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-265" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/image-augmentation.html">13.1. Image Augmentation</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/fine-tuning.html">13.2. Fine-Tuning</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/bounding-box.html">13.3. Object Detection and Bounding Boxes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/anchor.html">13.4. Anchor Boxes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/multiscale-object-detection.html">13.5. Multiscale Object Detection</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/object-detection-dataset.html">13.6. The Object Detection Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/ssd.html">13.7. Single Shot Multibox Detection</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/rcnn.html">13.8. Region-based CNNs (R-CNNs)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/semantic-segmentation-and-dataset.html">13.9. Semantic Segmentation and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/transposed-conv.html">13.10. Transposed Convolution</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/fcn.html">13.11. Fully Convolutional Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/neural-style.html">13.12. Neural Style Transfer</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/kaggle-cifar10.html">13.13. Image Classification (CIFAR-10) on Kaggle</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_computer-vision/kaggle-dog.html">13.14. Dog Breed Identification (ImageNet Dogs) on Kaggle</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/index.html">14. Natural Language Processing: Pretraining</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-280" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-280" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word2vec.html">14.1. Word Embedding (word2vec)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/approx-training.html">14.2. Approximate Training</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word-embedding-dataset.html">14.3. The Dataset for Pretraining Word Embeddings</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/word2vec-pretraining.html">14.4. Pretraining word2vec</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/glove.html">14.5. Word Embedding with Global Vectors (GloVe)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/subword-embedding.html">14.6. Subword Embedding</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/similarity-analogy.html">14.7. Word Similarity and Analogy</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert.html">14.8. Bidirectional Encoder Representations from Transformers (BERT)</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert-dataset.html">14.9. The Dataset for Pretraining BERT</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-pretraining/bert-pretraining.html">14.10. Pretraining BERT</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/index.html">15. Natural Language Processing: Applications</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-291" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-291" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-and-dataset.html">15.1. Sentiment Analysis and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-rnn.html">15.2. Sentiment Analysis: Using Recurrent Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/sentiment-analysis-cnn.html">15.3. Sentiment Analysis: Using Convolutional Neural Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-and-dataset.html">15.4. Natural Language Inference and the Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-attention.html">15.5. Natural Language Inference: Using Attention</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/finetuning-bert.html">15.6. Fine-Tuning BERT for Sequence-Level and Token-Level Applications</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_natural-language-processing-applications/natural-language-inference-bert.html">15.7. Natural Language Inference: Fine-Tuning BERT</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/index.html">16. Recommender Systems</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-299" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-299" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/recsys-intro.html">16.1. Overview of Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/movielens.html">16.2. The MovieLens Dataset</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/mf.html">16.3. Matrix Factorization</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/autorec.html">16.4. AutoRec: Rating Prediction with Autoencoders</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/ranking.html">16.5. Personalized Ranking for Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/neumf.html">16.6. Neural Collaborative Filtering for Personalized Ranking</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/seqrec.html">16.7. Sequence-Aware Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/ctr.html">16.8. Feature-Rich Recommender Systems</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/fm.html">16.9. Factorization Machines</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_recommender-systems/deepfm.html">16.10. Deep Factorization Machines</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/index.html">17. Generative Adversarial Networks</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-310" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-310" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/gan.html">17.1. Generative Adversarial Networks</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_generative-adversarial-networks/dcgan.html">17.2. Deep Convolutional Generative Adversarial Networks</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/index.html">18. Appendix: Mathematics for Deep Learning</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-313" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-313" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/geometry-linear-algebraic-ops.html">18.1. Geometry and Linear Algebraic Operations</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/eigendecomposition.html">18.2. Eigendecompositions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/single-variable-calculus.html">18.3. Single Variable Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/multivariable-calculus.html">18.4. Multivariable Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/integral-calculus.html">18.5. Integral Calculus</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/random-variables.html">18.6. Random Variables</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/maximum-likelihood.html">18.7. Maximum Likelihood</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/distributions.html">18.8. Distributions</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/naive-bayes.html">18.9. Naive Bayes</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/statistics.html">18.10. Statistics</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-mathematics-for-deep-learning/information-theory.html">18.11. Information Theory</a></span></li>
</ul></li>
<li class="toctree-l1">
<span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/index.html">19. Appendix: Tools for Deep Learning</a><span class="nav-toggle"><a class="mdl-button mdl-js-button mdl-button--icon" data-toggle="#globalnav-325" data-upgraded=",MaterialButton"><span style="color: #888"><i class="material-icons">keyboard_arrow_down</i></span></a></span></span><ul id="globalnav-325" class="collapse" style="display: none;">
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/jupyter.html">19.1. Using Jupyter</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/sagemaker.html">19.2. Using Amazon SageMaker</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/aws.html">19.3. Using AWS EC2 Instances</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/colab.html">19.4. Using Google Colab</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/selecting-servers-gpus.html">19.5. Selecting Servers and GPUs</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/contributing.html">19.6. Contributing to This Book</a></span></li>
<li class="toctree-l2"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html">19.7. <code class="docutils literal notranslate"><span class="pre">d2l</span></code> API Document</a></span></li>
</ul></li>
</ul>
<ul>
<li class="toctree-l1"><span class="link-wrapper"><a class="reference internal" href="https://d2l.ai/chapter_references/zreferences.html">References</a></span></li>
</ul>

            </nav>
        
        </div>
    
</header>

    <div class="document">
        <div class="page-content" role="main">
        
  <h1 class="mdl-color-text--primary">Source code for d2l.torch<div class="d2l-tabs" style="float:right"><div class="d2l-tabs__tab"><a href="https://colab.research.google.com/github/d2l-ai/d2l-en-colab/blob/master/_modules/d2l/torch.ipynb" onclick="captureOutboundLink(&#39;https://colab.research.google.com/github/d2l-ai/d2l-en-colab/blob/master/_modules/d2l/torch.ipynb&#39;); return false;"> <button style="float:right" ,="" id="Colab_[mxnet]" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect" data-upgraded=",MaterialButton,MaterialRipple" tabindex="0"> <i class=" fas fa-external-link-alt"></i> Colab [mxnet] <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button></a><div class="mdl-tooltip" data-mdl-for="Colab_[mxnet]" data-upgraded=",MaterialTooltip"> Open the notebook in Colab</div></div><div class="d2l-tabs__tab" style="display: none;"><a href="https://colab.research.google.com/github/d2l-ai/d2l-pytorch-colab/blob/master/_modules/d2l/torch.ipynb" onclick="captureOutboundLink(&#39;https://colab.research.google.com/github/d2l-ai/d2l-pytorch-colab/blob/master/_modules/d2l/torch.ipynb&#39;); return false;"> <button style="float:right" ,="" id="Colab_[pytorch]" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect" data-upgraded=",MaterialButton,MaterialRipple" tabindex="0"> <i class=" fas fa-external-link-alt"></i> Colab [pytorch] <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button></a><div class="mdl-tooltip" data-mdl-for="Colab_[pytorch]" data-upgraded=",MaterialTooltip"> Open the notebook in Colab</div></div><div class="d2l-tabs__tab" style="display: none;"><a href="https://colab.research.google.com/github/d2l-ai/d2l-tensorflow-colab/blob/master/_modules/d2l/torch.ipynb" onclick="captureOutboundLink(&#39;https://colab.research.google.com/github/d2l-ai/d2l-tensorflow-colab/blob/master/_modules/d2l/torch.ipynb&#39;); return false;"> <button style="float:right" ,="" id="Colab_[tensorflow]" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect" data-upgraded=",MaterialButton,MaterialRipple" tabindex="0"> <i class=" fas fa-external-link-alt"></i> Colab [tensorflow] <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button></a><div class="mdl-tooltip" data-mdl-for="Colab_[tensorflow]" data-upgraded=",MaterialTooltip"> Open the notebook in Colab</div></div></div></h1><div class="highlight"><pre><span></span><span class="c1"># This file is generated automatically through:</span>
<span class="c1">#    d2lbook build lib</span>
<span class="c1"># Don't edit it directly</span>

<span class="c1"># Defined in file: ./chapter_preface/index.md</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">d2l</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>


<span class="c1"># Defined in file: ./chapter_preface/index.md</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>


<span class="c1"># Defined in file: ./chapter_preliminaries/calculus.md</span>
<div class="viewcode-block" id="use_svg_display"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.use_svg_display">[docs]</a><span class="k">def</span> <span class="nf">use_svg_display</span><span class="p">():</span>
    <span class="sd">"""Use the svg format to display a plot in Jupyter."""</span>
    <span class="n">display</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_preliminaries/calculus.md</span>
<div class="viewcode-block" id="set_figsize"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.set_figsize">[docs]</a><span class="k">def</span> <span class="nf">set_figsize</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)):</span>
    <span class="sd">"""Set the figure size for matplotlib."""</span>
    <span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span></div>


<span class="c1"># Defined in file: ./chapter_preliminaries/calculus.md</span>
<div class="viewcode-block" id="set_axes"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.set_axes">[docs]</a><span class="k">def</span> <span class="nf">set_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">legend</span><span class="p">):</span>
    <span class="sd">"""Set the axes for matplotlib."""</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">yscale</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span></div>


<span class="c1"># Defined in file: ./chapter_preliminaries/calculus.md</span>
<div class="viewcode-block" id="plot"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.plot">[docs]</a><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="s1">'linear'</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">'linear'</span><span class="p">,</span>
         <span class="n">fmts</span><span class="o">=</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">'m--'</span><span class="p">,</span> <span class="s1">'g-.'</span><span class="p">,</span> <span class="s1">'r:'</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Plot data points."""</span>
    <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">set_figsize</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">axes</span> <span class="k">else</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># Return True if `X` (tensor or list) has 1 axis</span>
    <span class="k">def</span> <span class="nf">has_one_axis</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s2">"ndim"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"__len__"</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">has_one_axis</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">[[]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span>
    <span class="k">elif</span> <span class="n">has_one_axis</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">fmts</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="n">set_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">legend</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression.md</span>
<div class="viewcode-block" id="Timer"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer">[docs]</a><span class="k">class</span> <span class="nc">Timer</span><span class="p">:</span>
    <span class="sd">"""Record multiple running times."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<div class="viewcode-block" id="Timer.start"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Start the timer."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tik</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="Timer.stop"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Stop the timer and record the time in a list."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tik</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Timer.avg"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer.avg">[docs]</a>    <span class="k">def</span> <span class="nf">avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the average time."""</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

<div class="viewcode-block" id="Timer.sum"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer.sum">[docs]</a>    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the sum of time."""</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

<div class="viewcode-block" id="Timer.cumsum"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Timer.cumsum">[docs]</a>    <span class="k">def</span> <span class="nf">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the accumulated time."""</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression-scratch.md</span>
<div class="viewcode-block" id="synthetic_data"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.synthetic_data">[docs]</a><span class="k">def</span> <span class="nf">synthetic_data</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">):</span>
    <span class="sd">"""Generate y = Xw + b + noise."""</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">num_examples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
    <span class="n">y</span> <span class="o">+=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression-scratch.md</span>
<div class="viewcode-block" id="linreg"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.linreg">[docs]</a><span class="k">def</span> <span class="nf">linreg</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">"""The linear regression model."""</span>
    <span class="k">return</span> <span class="n">d2l</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression-scratch.md</span>
<div class="viewcode-block" id="squared_loss"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.squared_loss">[docs]</a><span class="k">def</span> <span class="nf">squared_loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">"""Squared loss."""</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y_hat</span> <span class="o">-</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression-scratch.md</span>
<div class="viewcode-block" id="sgd"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.sgd">[docs]</a><span class="k">def</span> <span class="nf">sgd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="sd">"""Minibatch stochastic gradient descent."""</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">/</span> <span class="n">batch_size</span>
            <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/linear-regression-concise.md</span>
<div class="viewcode-block" id="load_array"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_array">[docs]</a><span class="k">def</span> <span class="nf">load_array</span><span class="p">(</span><span class="n">data_arrays</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Construct a PyTorch data iterator."""</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="o">*</span><span class="n">data_arrays</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">is_train</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/image-classification-dataset.md</span>
<div class="viewcode-block" id="get_fashion_mnist_labels"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.get_fashion_mnist_labels">[docs]</a><span class="k">def</span> <span class="nf">get_fashion_mnist_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="sd">"""Return text labels for the Fashion-MNIST dataset."""</span>
    <span class="n">text_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'t-shirt'</span><span class="p">,</span> <span class="s1">'trouser'</span><span class="p">,</span> <span class="s1">'pullover'</span><span class="p">,</span> <span class="s1">'dress'</span><span class="p">,</span> <span class="s1">'coat'</span><span class="p">,</span> <span class="s1">'sandal'</span><span class="p">,</span> <span class="s1">'shirt'</span><span class="p">,</span>
        <span class="s1">'sneaker'</span><span class="p">,</span> <span class="s1">'bag'</span><span class="p">,</span> <span class="s1">'ankle boot'</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">text_labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/image-classification-dataset.md</span>
<div class="viewcode-block" id="show_images"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.show_images">[docs]</a><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="sd">"""Plot a list of images."""</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">num_rows</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
            <span class="c1"># Tensor Image</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># PIL Image</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">titles</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">axes</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/image-classification-dataset.md</span>
<div class="viewcode-block" id="get_dataloader_workers"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.get_dataloader_workers">[docs]</a><span class="k">def</span> <span class="nf">get_dataloader_workers</span><span class="p">():</span>
    <span class="sd">"""Use 4 processes to read the data."""</span>
    <span class="k">return</span> <span class="mi">4</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/image-classification-dataset.md</span>
<div class="viewcode-block" id="load_data_fashion_mnist"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_fashion_mnist">[docs]</a><span class="k">def</span> <span class="nf">load_data_fashion_mnist</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Download the Fashion-MNIST dataset and then load it into memory."""</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">resize</span><span class="p">:</span>
        <span class="n">trans</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">resize</span><span class="p">))</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">mnist_train</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">"../data"</span><span class="p">,</span>
                                                    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                                                    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_test</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">"../data"</span><span class="p">,</span>
                                                   <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                                                   <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="n">get_dataloader_workers</span><span class="p">()),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="n">get_dataloader_workers</span><span class="p">()))</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="accuracy"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.accuracy">[docs]</a><span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">"""Compute the number of correct predictions."""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cmp</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="evaluate_accuracy"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.evaluate_accuracy">[docs]</a><span class="k">def</span> <span class="nf">evaluate_accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">):</span>
    <span class="sd">"""Compute the accuracy for a model on a dataset."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set the model to evaluation mode</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># No. of correct predictions, no. of predictions</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="Accumulator"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Accumulator">[docs]</a><span class="k">class</span> <span class="nc">Accumulator</span><span class="p">:</span>
    <span class="sd">"""For accumulating sums over `n` variables."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="train_epoch_ch3"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_epoch_ch3">[docs]</a><span class="k">def</span> <span class="nf">train_epoch_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">):</span>
    <span class="sd">"""The training loop defined in Chapter 3."""</span>
    <span class="c1"># Set the model to training mode</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="c1"># Sum of training loss, sum of training accuracy, no. of examples</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">Accumulator</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">train_iter</span><span class="p">:</span>
        <span class="c1"># Compute gradients and update parameters</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updater</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">):</span>
            <span class="c1"># Using PyTorch in-built optimizer &amp; loss criterion</span>
            <span class="n">updater</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">updater</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Using custom built optimizer &amp; loss criterion</span>
            <span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">updater</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
    <span class="c1"># Return training loss and training accuracy</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="Animator"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Animator">[docs]</a><span class="k">class</span> <span class="nc">Animator</span><span class="p">:</span>
    <span class="sd">"""For plotting data in animation."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="s1">'linear'</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">'linear'</span><span class="p">,</span>
                 <span class="n">fmts</span><span class="o">=</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">'m--'</span><span class="p">,</span> <span class="s1">'g-.'</span><span class="p">,</span> <span class="s1">'r:'</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)):</span>
        <span class="c1"># Incrementally plot multiple lines</span>
        <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d2l</span><span class="o">.</span><span class="n">use_svg_display</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,]</span>
        <span class="c1"># Use a lambda function to capture arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_axes</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">d2l</span><span class="o">.</span><span class="n">set_axes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span>
            <span class="mi">0</span><span class="p">],</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">legend</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fmts</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Add multiple data points into the figure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">"__len__"</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">"__len__"</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_axes</span><span class="p">()</span>
        <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="train_ch3"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_ch3">[docs]</a><span class="k">def</span> <span class="nf">train_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">updater</span><span class="p">):</span>
    <span class="sd">"""Train a model (defined in Chapter 3)."""</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                        <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">'train loss'</span><span class="p">,</span> <span class="s1">'train acc'</span><span class="p">,</span> <span class="s1">'test acc'</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">train_metrics</span> <span class="o">=</span> <span class="n">train_epoch_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">evaluate_accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
        <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">train_metrics</span> <span class="o">+</span> <span class="p">(</span><span class="n">test_acc</span><span class="p">,))</span>
    <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_metrics</span>
    <span class="k">assert</span> <span class="n">train_loss</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">train_loss</span>
    <span class="k">assert</span> <span class="n">train_acc</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">train_acc</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">train_acc</span>
    <span class="k">assert</span> <span class="n">test_acc</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">test_acc</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">test_acc</span></div>


<span class="c1"># Defined in file: ./chapter_linear-networks/softmax-regression-scratch.md</span>
<div class="viewcode-block" id="predict_ch3"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.predict_ch3">[docs]</a><span class="k">def</span> <span class="nf">predict_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">"""Predict labels (defined in Chapter 3)."""</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">test_iter</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">trues</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_fashion_mnist_labels</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_fashion_mnist_labels</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">true</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="n">pred</span> <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trues</span><span class="p">,</span> <span class="n">preds</span><span class="p">)]</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">show_images</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">],</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                    <span class="n">titles</span><span class="o">=</span><span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">])</span></div>


<span class="c1"># Defined in file: ./chapter_multilayer-perceptrons/underfit-overfit.md</span>
<div class="viewcode-block" id="evaluate_loss"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.evaluate_loss">[docs]</a><span class="k">def</span> <span class="nf">evaluate_loss</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
    <span class="sd">"""Evaluate the loss of a model on the given dataset."""</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sum of losses, no. of examples</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_multilayer-perceptrons/kaggle-house-price.md</span>
<span class="n">DATA_HUB</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">DATA_URL</span> <span class="o">=</span> <span class="s1">'http://d2l-data.s3-accelerate.amazonaws.com/'</span>


<span class="c1"># Defined in file: ./chapter_multilayer-perceptrons/kaggle-house-price.md</span>
<div class="viewcode-block" id="download"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.download">[docs]</a><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="s1">'data'</span><span class="p">)):</span>
    <span class="sd">"""Download a file inserted into DATA_HUB, return the local filename."""</span>
    <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">DATA_HUB</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="n">DATA_HUB</span><span class="si">}</span><span class="s2">."</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">sha1_hash</span> <span class="o">=</span> <span class="n">DATA_HUB</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1048576</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sha1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">sha1_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fname</span>  <span class="c1"># Hit cache</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Downloading </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">...'</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span></div>


<span class="c1"># Defined in file: ./chapter_multilayer-perceptrons/kaggle-house-price.md</span>
<div class="viewcode-block" id="download_extract"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.download_extract">[docs]</a><span class="k">def</span> <span class="nf">download_extract</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Download and extract a zip/tar file."""</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">download</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">data_dir</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">'.zip'</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'.tar'</span><span class="p">,</span> <span class="s1">'.gz'</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'Only zip/tar files can be extracted.'</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">folder</span> <span class="k">else</span> <span class="n">data_dir</span></div>


<div class="viewcode-block" id="download_all"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.download_all">[docs]</a><span class="k">def</span> <span class="nf">download_all</span><span class="p">():</span>
    <span class="sd">"""Download all files in the DATA_HUB."""</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">DATA_HUB</span><span class="p">:</span>
        <span class="n">download</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_multilayer-perceptrons/kaggle-house-price.md</span>
<span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'kaggle_house_train'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'kaggle_house_pred_train.csv'</span><span class="p">,</span>
                                  <span class="s1">'585e9cc93e70b39160e7921475f9bcd7d31219ce'</span><span class="p">)</span>

<span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'kaggle_house_test'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'kaggle_house_pred_test.csv'</span><span class="p">,</span>
                                 <span class="s1">'fa19780a7b011d9b009e8bff8e99922a8ee2eb90'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_deep-learning-computation/use-gpu.md</span>
<div class="viewcode-block" id="try_gpu"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.try_gpu">[docs]</a><span class="k">def</span> <span class="nf">try_gpu</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">"""Return gpu(i) if exists, otherwise return cpu()."""</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cuda:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)</span></div>


<div class="viewcode-block" id="try_all_gpus"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.try_all_gpus">[docs]</a><span class="k">def</span> <span class="nf">try_all_gpus</span><span class="p">():</span>
    <span class="sd">"""Return all available GPUs, or [cpu(),] if no GPU exists."""</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cuda:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">devices</span> <span class="k">if</span> <span class="n">devices</span> <span class="k">else</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)]</span></div>


<span class="c1"># Defined in file: ./chapter_convolutional-neural-networks/conv-layer.md</span>
<div class="viewcode-block" id="corr2d"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.corr2d">[docs]</a><span class="k">def</span> <span class="nf">corr2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="sd">"""Compute 2D cross-correlation."""</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Y</span></div>


<span class="c1"># Defined in file: ./chapter_convolutional-neural-networks/lenet.md</span>
<div class="viewcode-block" id="evaluate_accuracy_gpu"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.evaluate_accuracy_gpu">[docs]</a><span class="k">def</span> <span class="nf">evaluate_accuracy_gpu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Compute the accuracy for a model on a dataset using a GPU."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set the model to evaluation mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
    <span class="c1"># No. of correct predictions, no. of predictions</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Required for BERT Fine-tuning (to be covered later)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_convolutional-neural-networks/lenet.md</span>
<div class="viewcode-block" id="train_ch6"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_ch6">[docs]</a><span class="k">def</span> <span class="nf">train_ch6</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="sd">"""Train a model with a GPU (defined in Chapter 6)."""</span>
    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

    <span class="n">net</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'training on'</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span>
                            <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">'train loss'</span><span class="p">,</span> <span class="s1">'train acc'</span><span class="p">,</span> <span class="s1">'test acc'</span><span class="p">])</span>
    <span class="n">timer</span><span class="p">,</span> <span class="n">num_batches</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_iter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="c1"># Sum of training loss, sum of training accuracy, no. of examples</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_iter</span><span class="p">):</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d2l</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">train_l</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">train_acc</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_batches</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_batches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_batches</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">train_l</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">evaluate_accuracy_gpu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
        <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'loss </span><span class="si">{</span><span class="n">train_l</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, train acc </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, '</span>
          <span class="sa">f</span><span class="s1">'test acc </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_epochs</span> <span class="o">/</span> <span class="n">timer</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> examples/sec '</span>
          <span class="sa">f</span><span class="s1">'on </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_convolutional-modern/resnet.md</span>
<div class="viewcode-block" id="Residual"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Residual">[docs]</a><span class="k">class</span> <span class="nc">Residual</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The Residual block of ResNet."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">use_1x1conv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                               <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                               <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_1x1conv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span>
                                   <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>

<div class="viewcode-block" id="Residual.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Residual.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">+=</span> <span class="n">X</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/text-preprocessing.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'time_machine'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'timemachine.txt'</span><span class="p">,</span>
                                <span class="s1">'090b5e7e70c295757f55df93cb0a180b9691891a'</span><span class="p">)</span>


<div class="viewcode-block" id="read_time_machine"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_time_machine">[docs]</a><span class="k">def</span> <span class="nf">read_time_machine</span><span class="p">():</span>
    <span class="sd">"""Load the time machine dataset into a list of text lines."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'time_machine'</span><span class="p">),</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'[^A-Za-z]+'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/text-preprocessing.md</span>
<div class="viewcode-block" id="tokenize"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.tokenize">[docs]</a><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">'word'</span><span class="p">):</span>
    <span class="sd">"""Split text lines into word or character tokens."""</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">'word'</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">'char'</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'ERROR: unknown token type: '</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/text-preprocessing.md</span>
<div class="viewcode-block" id="Vocab"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Vocab">[docs]</a><span class="k">class</span> <span class="nc">Vocab</span><span class="p">:</span>
    <span class="sd">"""Vocabulary for text."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reserved_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">reserved_tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reserved_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Sort according to frequencies</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">count_corpus</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_freqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># The index for the unknown token is 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'&lt;unk&gt;'</span><span class="p">]</span> <span class="o">+</span> <span class="n">reserved_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_freqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">to_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Index for the unknown token</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">token_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Index for the unknown token</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_freqs</span></div>


<div class="viewcode-block" id="count_corpus"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.count_corpus">[docs]</a><span class="k">def</span> <span class="nf">count_corpus</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
    <span class="sd">"""Count token frequencies."""</span>
    <span class="c1"># Here `tokens` is a 1D list or 2D list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Flatten a list of token lists into a list of tokens</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/text-preprocessing.md</span>
<div class="viewcode-block" id="load_corpus_time_machine"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_corpus_time_machine">[docs]</a><span class="k">def</span> <span class="nf">load_corpus_time_machine</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Return token indices and the vocabulary of the time machine dataset."""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">read_time_machine</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">'char'</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocab</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="c1"># Since each text line in the time machine dataset is not necessarily a</span>
    <span class="c1"># sentence or a paragraph, flatten all the text lines into a single list</span>
    <span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="n">corpus</span><span class="p">[:</span><span class="n">max_tokens</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">corpus</span><span class="p">,</span> <span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/language-models-and-dataset.md</span>
<div class="viewcode-block" id="seq_data_iter_random"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.seq_data_iter_random">[docs]</a><span class="k">def</span> <span class="nf">seq_data_iter_random</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="sd">"""Generate a minibatch of subsequences using random sampling."""</span>
    <span class="c1"># Start with a random offset (inclusive of `num_steps - 1`) to partition a</span>
    <span class="c1"># sequence</span>
    <span class="n">corpus</span> <span class="o">=</span> <span class="n">corpus</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):]</span>
    <span class="c1"># Subtract 1 since we need to account for labels</span>
    <span class="n">num_subseqs</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_steps</span>
    <span class="c1"># The starting indices for subsequences of length `num_steps`</span>
    <span class="n">initial_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_subseqs</span> <span class="o">*</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">))</span>
    <span class="c1"># In random sampling, the subsequences from two adjacent random</span>
    <span class="c1"># minibatches during iteration are not necessarily adjacent on the</span>
    <span class="c1"># original sequence</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">initial_indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
        <span class="c1"># Return a sequence of length `num_steps` starting from `pos`</span>
        <span class="k">return</span> <span class="n">corpus</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">num_steps</span><span class="p">]</span>

    <span class="n">num_batches</span> <span class="o">=</span> <span class="n">num_subseqs</span> <span class="o">//</span> <span class="n">batch_size</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># Here, `initial_indices` contains randomized starting indices for</span>
        <span class="c1"># subsequences</span>
        <span class="n">initial_indices_per_batch</span> <span class="o">=</span> <span class="n">initial_indices</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">initial_indices_per_batch</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">initial_indices_per_batch</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/language-models-and-dataset.md</span>
<div class="viewcode-block" id="seq_data_iter_sequential"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.seq_data_iter_sequential">[docs]</a><span class="k">def</span> <span class="nf">seq_data_iter_sequential</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="sd">"""Generate a minibatch of subsequences using sequential partitioning."""</span>
    <span class="c1"># Start with a random offset to partition a sequence</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">num_tokens</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">num_tokens</span><span class="p">])</span>
    <span class="n">Ys</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_tokens</span><span class="p">])</span>
    <span class="n">Xs</span><span class="p">,</span> <span class="n">Ys</span> <span class="o">=</span> <span class="n">Xs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">Ys</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_batches</span> <span class="o">=</span> <span class="n">Xs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">num_steps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">num_steps</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Ys</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">num_steps</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/language-models-and-dataset.md</span>
<div class="viewcode-block" id="SeqDataLoader"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.SeqDataLoader">[docs]</a><span class="k">class</span> <span class="nc">SeqDataLoader</span><span class="p">:</span>
    <span class="sd">"""An iterator to load sequence data."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">use_random_iter</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">use_random_iter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_iter_fn</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">seq_data_iter_random</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_iter_fn</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">seq_data_iter_sequential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">load_corpus_time_machine</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_iter_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/language-models-and-dataset.md</span>
<div class="viewcode-block" id="load_data_time_machine"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_time_machine">[docs]</a><span class="k">def</span> <span class="nf">load_data_time_machine</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">use_random_iter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">max_tokens</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="sd">"""Return the iterator and the vocabulary of the time machine dataset."""</span>
    <span class="n">data_iter</span> <span class="o">=</span> <span class="n">SeqDataLoader</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">use_random_iter</span><span class="p">,</span>
                              <span class="n">max_tokens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">data_iter</span><span class="o">.</span><span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-scratch.md</span>
<div class="viewcode-block" id="RNNModelScratch"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.RNNModelScratch">[docs]</a><span class="k">class</span> <span class="nc">RNNModelScratch</span><span class="p">:</span>
    <span class="sd">"""A RNN Model implemented from scratch."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">get_params</span><span class="p">,</span>
                 <span class="n">init_state</span><span class="p">,</span> <span class="n">forward_fn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span> <span class="o">=</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_fn</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">forward_fn</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">begin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-scratch.md</span>
<div class="viewcode-block" id="predict_ch8"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.predict_ch8">[docs]</a><span class="k">def</span> <span class="nf">predict_ch8</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">num_preds</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="sd">"""Generate new characters following the `prefix`."""</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">begin_state</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
    <span class="n">get_input</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
                                    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Warm-up period</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">get_input</span><span class="p">(),</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_preds</span><span class="p">):</span>  <span class="c1"># Predict `num_preds` steps</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">get_input</span><span class="p">(),</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-scratch.md</span>
<div class="viewcode-block" id="grad_clipping"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.grad_clipping">[docs]</a><span class="k">def</span> <span class="nf">grad_clipping</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">"""Clip the gradient."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">params</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">theta</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="p">[:]</span> <span class="o">*=</span> <span class="n">theta</span> <span class="o">/</span> <span class="n">norm</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-scratch.md</span>
<div class="viewcode-block" id="train_epoch_ch8"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_epoch_ch8">[docs]</a><span class="k">def</span> <span class="nf">train_epoch_ch8</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">use_random_iter</span><span class="p">):</span>
    <span class="sd">"""Train a net within one epoch (defined in Chapter 8)."""</span>
    <span class="n">state</span><span class="p">,</span> <span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sum of training loss, no. of tokens</span>
    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">train_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">use_random_iter</span><span class="p">:</span>
            <span class="c1"># Initialize `state` when either it is the first iteration or</span>
            <span class="c1"># using random sampling</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">begin_state</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="c1"># `state` is a tensor for `nn.GRU`</span>
                <span class="n">state</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># `state` is a tuple of tensors for `nn.LSTM` and</span>
                <span class="c1"># for our custom scratch implementation</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y_hat</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">long</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updater</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">):</span>
            <span class="n">updater</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">grad_clipping</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">updater</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">grad_clipping</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Since the `mean` function has been invoked</span>
            <span class="n">updater</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="n">d2l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-scratch.md</span>
<div class="viewcode-block" id="train_ch8"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_ch8">[docs]</a><span class="k">def</span> <span class="nf">train_ch8</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
              <span class="n">use_random_iter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Train a model (defined in Chapter 8)."""</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'perplexity'</span><span class="p">,</span>
                            <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">'train'</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">])</span>
    <span class="c1"># Initialize</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">updater</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">updater</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n">d2l</span><span class="o">.</span><span class="n">sgd</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="n">predict</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">predict_ch8</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="c1"># Train and predict</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">ppl</span><span class="p">,</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">train_epoch_ch8</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
                                     <span class="n">use_random_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="s1">'time traveller'</span><span class="p">))</span>
            <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">ppl</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'perplexity </span><span class="si">{</span><span class="n">ppl</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">speed</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> tokens/sec on </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="s1">'time traveller'</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="s1">'traveller'</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-neural-networks/rnn-concise.md</span>
<div class="viewcode-block" id="RNNModel"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.RNNModel">[docs]</a><span class="k">class</span> <span class="nc">RNNModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The RNN model."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rnn_layer</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">rnn_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="c1"># If the RNN is bidirectional (to be introduced later),</span>
        <span class="c1"># `num_directions` should be 2, else it should be 1.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_directions</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_directions</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>

<div class="viewcode-block" id="RNNModel.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.RNNModel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c1"># The fully connected layer will first change the shape of `Y` to</span>
        <span class="c1"># (`num_steps` * `batch_size`, `num_hiddens`). Its output shape is</span>
        <span class="c1"># (`num_steps` * `batch_size`, `vocab_size`).</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">state</span></div>

    <span class="k">def</span> <span class="nf">begin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">):</span>
            <span class="c1"># `nn.GRU` takes a tensor as hidden state</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_directions</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># `nn.LSTM` takes a tuple of hidden states</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_directions</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">),</span>
                                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_directions</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">),</span>
                                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'fra-eng'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'fra-eng.zip'</span><span class="p">,</span>
                           <span class="s1">'94646ad1522d915e7b0f9296181140edcf86a4f5'</span><span class="p">)</span>


<div class="viewcode-block" id="read_data_nmt"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_data_nmt">[docs]</a><span class="k">def</span> <span class="nf">read_data_nmt</span><span class="p">():</span>
    <span class="sd">"""Load the English-French dataset."""</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'fra-eng'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'fra.txt'</span><span class="p">),</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="preprocess_nmt"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.preprocess_nmt">[docs]</a><span class="k">def</span> <span class="nf">preprocess_nmt</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">"""Preprocess the English-French dataset."""</span>
    <span class="k">def</span> <span class="nf">no_space</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">prev_char</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="s1">',.!?'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prev_char</span> <span class="o">!=</span> <span class="s1">' '</span>

    <span class="c1"># Replace non-breaking space with space, and convert uppercase letters to</span>
    <span class="c1"># lowercase ones</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\u202f</span><span class="s1">'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\xa0</span><span class="s1">'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># Insert space between words and punctuation marks</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">' '</span> <span class="o">+</span> <span class="n">char</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">no_space</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="n">char</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">)]</span>
    <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="tokenize_nmt"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.tokenize_nmt">[docs]</a><span class="k">def</span> <span class="nf">tokenize_nmt</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Tokenize the English-French dataset."""</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">num_examples</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">num_examples</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="show_list_len_pair_hist"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.show_list_len_pair_hist">[docs]</a><span class="k">def</span> <span class="nf">show_list_len_pair_hist</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span><span class="p">):</span>
    <span class="sd">"""Plot the histogram for list length pairs."""</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">set_figsize</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([[</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">],</span>
                                  <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">]])</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_hatch</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="truncate_pad"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.truncate_pad">[docs]</a><span class="k">def</span> <span class="nf">truncate_pad</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">padding_token</span><span class="p">):</span>
    <span class="sd">"""Truncate or pad sequences."""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_steps</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span><span class="p">[:</span><span class="n">num_steps</span><span class="p">]</span>  <span class="c1"># Truncate</span>
    <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="p">[</span><span class="n">padding_token</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_steps</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>  <span class="c1"># Pad</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="build_array_nmt"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.build_array_nmt">[docs]</a><span class="k">def</span> <span class="nf">build_array_nmt</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
    <span class="sd">"""Transform text sequences of machine translation into minibatches."""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;eos&gt;'</span><span class="p">]]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
        <span class="n">truncate_pad</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>
    <span class="n">valid_len</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">array</span> <span class="o">!=</span> <span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">],</span> <span class="n">d2l</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                               <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">,</span> <span class="n">valid_len</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/machine-translation-and-dataset.md</span>
<div class="viewcode-block" id="load_data_nmt"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_nmt">[docs]</a><span class="k">def</span> <span class="nf">load_data_nmt</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
    <span class="sd">"""Return the iterator and the vocabularies of the translation dataset."""</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">preprocess_nmt</span><span class="p">(</span><span class="n">read_data_nmt</span><span class="p">())</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">tokenize_nmt</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">)</span>
    <span class="n">src_vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">reserved_tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">,</span> <span class="s1">'&lt;bos&gt;'</span><span class="p">,</span> <span class="s1">'&lt;eos&gt;'</span><span class="p">])</span>
    <span class="n">tgt_vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">reserved_tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">,</span> <span class="s1">'&lt;bos&gt;'</span><span class="p">,</span> <span class="s1">'&lt;eos&gt;'</span><span class="p">])</span>
    <span class="n">src_array</span><span class="p">,</span> <span class="n">src_valid_len</span> <span class="o">=</span> <span class="n">build_array_nmt</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">src_vocab</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">tgt_array</span><span class="p">,</span> <span class="n">tgt_valid_len</span> <span class="o">=</span> <span class="n">build_array_nmt</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_array</span><span class="p">,</span> <span class="n">src_valid_len</span><span class="p">,</span> <span class="n">tgt_array</span><span class="p">,</span> <span class="n">tgt_valid_len</span><span class="p">)</span>
    <span class="n">data_iter</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">load_array</span><span class="p">(</span><span class="n">data_arrays</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">src_vocab</span><span class="p">,</span> <span class="n">tgt_vocab</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/encoder-decoder.md</span>
<div class="viewcode-block" id="Encoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Encoder">[docs]</a><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The base encoder interface for the encoder-decoder architecture."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Encoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Encoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/encoder-decoder.md</span>
<div class="viewcode-block" id="Decoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Decoder">[docs]</a><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The base decoder interface for the encoder-decoder architecture."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enc_outputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="Decoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Decoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/encoder-decoder.md</span>
<div class="viewcode-block" id="EncoderDecoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.EncoderDecoder">[docs]</a><span class="k">class</span> <span class="nc">EncoderDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The base class for the encoder-decoder architecture."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderDecoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>

<div class="viewcode-block" id="EncoderDecoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.EncoderDecoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enc_X</span><span class="p">,</span> <span class="n">dec_X</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">enc_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">enc_X</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">dec_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">init_state</span><span class="p">(</span><span class="n">enc_outputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">dec_X</span><span class="p">,</span> <span class="n">dec_state</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="Seq2SeqEncoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Seq2SeqEncoder">[docs]</a><span class="k">class</span> <span class="nc">Seq2SeqEncoder</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">Encoder</span><span class="p">):</span>
    <span class="sd">"""The RNN encoder for sequence to sequence learning."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span>
                 <span class="n">dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Seq2SeqEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Embedding layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span>
                          <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

<div class="viewcode-block" id="Seq2SeqEncoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Seq2SeqEncoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># The output `X` shape: (`batch_size`, `num_steps`, `embed_size`)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># In RNN models, the first axis corresponds to time steps</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># When state is not mentioned, it defaults to zeros</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># `output` shape: (`num_steps`, `batch_size`, `num_hiddens`)</span>
        <span class="c1"># `state` shape: (`num_layers`, `batch_size`, `num_hiddens`)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">state</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="sequence_mask"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.sequence_mask">[docs]</a><span class="k">def</span> <span class="nf">sequence_mask</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">valid_len</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">"""Mask irrelevant entries in sequences."""</span>
    <span class="n">maxlen</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">maxlen</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">valid_len</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">X</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="MaskedSoftmaxCELoss"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MaskedSoftmaxCELoss">[docs]</a><span class="k">class</span> <span class="nc">MaskedSoftmaxCELoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">):</span>
    <span class="sd">"""The softmax cross-entropy loss with masks."""</span>

    <span class="c1"># `pred` shape: (`batch_size`, `num_steps`, `vocab_size`)</span>
    <span class="c1"># `label` shape: (`batch_size`, `num_steps`)</span>
    <span class="c1"># `valid_len` shape: (`batch_size`,)</span>
<div class="viewcode-block" id="MaskedSoftmaxCELoss.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MaskedSoftmaxCELoss.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">valid_len</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">sequence_mask</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">valid_len</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="s1">'none'</span>
        <span class="n">unweighted_loss</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MaskedSoftmaxCELoss</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">weighted_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">unweighted_loss</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weighted_loss</span></div></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="train_seq2seq"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_seq2seq">[docs]</a><span class="k">def</span> <span class="nf">train_seq2seq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="sd">"""Train a model for sequence to sequence."""</span>
    <span class="k">def</span> <span class="nf">xavier_init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_flat_weights_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">"weight"</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

    <span class="n">net</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xavier_init_weights</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">MaskedSoftmaxCELoss</span><span class="p">()</span>
    <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'loss'</span><span class="p">,</span>
                            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sum of training loss, no. of tokens</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">X_valid_len</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y_valid_len</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="n">bos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tgt_vocab</span><span class="p">[</span><span class="s1">'&lt;bos&gt;'</span><span class="p">]]</span> <span class="o">*</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dec_input</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bos</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Teacher forcing</span>
            <span class="n">Y_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dec_input</span><span class="p">,</span> <span class="n">X_valid_len</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y_valid_len</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>  <span class="c1"># Make the loss scalar for `backward`</span>
            <span class="n">d2l</span><span class="o">.</span><span class="n">grad_clipping</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">num_tokens</span> <span class="o">=</span> <span class="n">Y_valid_len</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">num_tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'loss </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> '</span>
          <span class="sa">f</span><span class="s1">'tokens/sec on </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="predict_seq2seq"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.predict_seq2seq">[docs]</a><span class="k">def</span> <span class="nf">predict_seq2seq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">,</span> <span class="n">src_vocab</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span>
                    <span class="n">device</span><span class="p">,</span> <span class="n">save_attention_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Predict for sequence to sequence."""</span>
    <span class="c1"># Set `net` to eval mode for inference</span>
    <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">src_vocab</span><span class="p">[</span><span class="n">src_sentence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">src_vocab</span><span class="p">[</span><span class="s1">'&lt;eos&gt;'</span><span class="p">]]</span>
    <span class="n">enc_valid_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">truncate_pad</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">src_vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span>
    <span class="c1"># Add the batch axis</span>
    <span class="n">enc_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">enc_outputs</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">enc_X</span><span class="p">,</span> <span class="n">enc_valid_len</span><span class="p">)</span>
    <span class="n">dec_state</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">init_state</span><span class="p">(</span><span class="n">enc_outputs</span><span class="p">,</span> <span class="n">enc_valid_len</span><span class="p">)</span>
    <span class="c1"># Add the batch axis</span>
    <span class="n">dec_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tgt_vocab</span><span class="p">[</span><span class="s1">'&lt;bos&gt;'</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">output_seq</span><span class="p">,</span> <span class="n">attention_weight_seq</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">dec_state</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">dec_X</span><span class="p">,</span> <span class="n">dec_state</span><span class="p">)</span>
        <span class="c1"># We use the token with the highest prediction likelihood as the input</span>
        <span class="c1"># of the decoder at the next time step</span>
        <span class="n">dec_X</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">dec_X</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># Save attention weights (to be covered later)</span>
        <span class="k">if</span> <span class="n">save_attention_weights</span><span class="p">:</span>
            <span class="n">attention_weight_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">attention_weights</span><span class="p">)</span>
        <span class="c1"># Once the end-of-sequence token is predicted, the generation of the</span>
        <span class="c1"># output sequence is complete</span>
        <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">tgt_vocab</span><span class="p">[</span><span class="s1">'&lt;eos&gt;'</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="n">output_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tgt_vocab</span><span class="o">.</span><span class="n">to_tokens</span><span class="p">(</span><span class="n">output_seq</span><span class="p">)),</span> <span class="n">attention_weight_seq</span></div>


<span class="c1"># Defined in file: ./chapter_recurrent-modern/seq2seq.md</span>
<div class="viewcode-block" id="bleu"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.bleu">[docs]</a><span class="k">def</span> <span class="nf">bleu</span><span class="p">(</span><span class="n">pred_seq</span><span class="p">,</span> <span class="n">label_seq</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">"""Compute the BLEU."""</span>
    <span class="n">pred_tokens</span><span class="p">,</span> <span class="n">label_tokens</span> <span class="o">=</span> <span class="n">pred_seq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">),</span> <span class="n">label_seq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>
    <span class="n">len_pred</span><span class="p">,</span> <span class="n">len_label</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_tokens</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_tokens</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">len_label</span> <span class="o">/</span> <span class="n">len_pred</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">num_matches</span><span class="p">,</span> <span class="n">label_subs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_label</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">label_subs</span><span class="p">[</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_pred</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label_subs</span><span class="p">[</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pred_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_matches</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">label_subs</span><span class="p">[</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pred_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">score</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">num_matches</span> <span class="o">/</span> <span class="p">(</span><span class="n">len_pred</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/attention-cues.md</span>
<div class="viewcode-block" id="show_heatmaps"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.show_heatmaps">[docs]</a><span class="k">def</span> <span class="nf">show_heatmaps</span><span class="p">(</span><span class="n">matrices</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="s1">'Reds'</span><span class="p">):</span>
    <span class="sd">"""Show heatmaps of matrices."""</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">matrices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                 <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row_axes</span><span class="p">,</span> <span class="n">row_matrices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">matrices</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">row_axes</span><span class="p">,</span> <span class="n">row_matrices</span><span class="p">)):</span>
            <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">matrix</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">titles</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/attention-scoring-functions.md</span>
<div class="viewcode-block" id="masked_softmax"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.masked_softmax">[docs]</a><span class="k">def</span> <span class="nf">masked_softmax</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">):</span>
    <span class="sd">"""Perform softmax operation by masking elements on the last axis."""</span>
    <span class="c1"># `X`: 3D tensor, `valid_lens`: 1D or 2D tensor</span>
    <span class="k">if</span> <span class="n">valid_lens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">valid_lens</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">valid_lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">valid_lens</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_lens</span> <span class="o">=</span> <span class="n">valid_lens</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># On the last axis, replace masked elements with a very large negative</span>
        <span class="c1"># value, whose exponentiation outputs 0</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">valid_lens</span><span class="p">,</span>
                              <span class="n">value</span><span class="o">=-</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/attention-scoring-functions.md</span>
<div class="viewcode-block" id="AdditiveAttention"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.AdditiveAttention">[docs]</a><span class="k">class</span> <span class="nc">AdditiveAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Additive attention."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AdditiveAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">query_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

<div class="viewcode-block" id="AdditiveAttention.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.AdditiveAttention.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">):</span>
        <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">queries</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="c1"># After dimension expansion, shape of `queries`: (`batch_size`, no. of</span>
        <span class="c1"># queries, 1, `num_hiddens`) and shape of `keys`: (`batch_size`, 1,</span>
        <span class="c1"># no. of key-value pairs, `num_hiddens`). Sum them up with</span>
        <span class="c1"># broadcasting</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">keys</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="c1"># There is only one output of `self.w_v`, so we remove the last</span>
        <span class="c1"># one-dimensional entry from the shape. Shape of `scores`:</span>
        <span class="c1"># (`batch_size`, no. of queries, no. of key-value pairs)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span> <span class="o">=</span> <span class="n">masked_softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>
        <span class="c1"># Shape of `values`: (`batch_size`, no. of key-value pairs, value</span>
        <span class="c1"># dimension)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/attention-scoring-functions.md</span>
<div class="viewcode-block" id="DotProductAttention"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.DotProductAttention">[docs]</a><span class="k">class</span> <span class="nc">DotProductAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Scaled dot product attention."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DotProductAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

    <span class="c1"># Shape of `queries`: (`batch_size`, no. of queries, `d`)</span>
    <span class="c1"># Shape of `keys`: (`batch_size`, no. of key-value pairs, `d`)</span>
    <span class="c1"># Shape of `values`: (`batch_size`, no. of key-value pairs, value</span>
    <span class="c1"># dimension)</span>
    <span class="c1"># Shape of `valid_lens`: (`batch_size`,) or (`batch_size`, no. of queries)</span>
<div class="viewcode-block" id="DotProductAttention.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.DotProductAttention.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">valid_lens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Set `transpose_b=True` to swap the last two dimensions of `keys`</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span> <span class="o">=</span> <span class="n">masked_softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/bahdanau-attention.md</span>
<div class="viewcode-block" id="AttentionDecoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.AttentionDecoder">[docs]</a><span class="k">class</span> <span class="nc">AttentionDecoder</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">Decoder</span><span class="p">):</span>
    <span class="sd">"""The base attention-based decoder interface."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionDecoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attention_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/multihead-attention.md</span>
<div class="viewcode-block" id="MultiHeadAttention"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MultiHeadAttention">[docs]</a><span class="k">class</span> <span class="nc">MultiHeadAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Multi-head attention."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span>
                 <span class="n">num_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiHeadAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">DotProductAttention</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">query_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">value_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>

<div class="viewcode-block" id="MultiHeadAttention.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MultiHeadAttention.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">):</span>
        <span class="c1"># Shape of `queries`, `keys`, or `values`:</span>
        <span class="c1"># (`batch_size`, no. of queries or key-value pairs, `num_hiddens`)</span>
        <span class="c1"># Shape of `valid_lens`:</span>
        <span class="c1"># (`batch_size`,) or (`batch_size`, no. of queries)</span>
        <span class="c1"># After transposing, shape of output `queries`, `keys`, or `values`:</span>
        <span class="c1"># (`batch_size` * `num_heads`, no. of queries or key-value pairs,</span>
        <span class="c1"># `num_hiddens` / `num_heads`)</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="n">transpose_qkv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">queries</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">transpose_qkv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">transpose_qkv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">valid_lens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># On axis 0, copy the first item (scalar or vector) for</span>
            <span class="c1"># `num_heads` times, then copy the next item, and so on</span>
            <span class="n">valid_lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">valid_lens</span><span class="p">,</span>
                                                 <span class="n">repeats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span>
                                                 <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Shape of `output`: (`batch_size` * `num_heads`, no. of queries,</span>
        <span class="c1"># `num_hiddens` / `num_heads`)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>

        <span class="c1"># Shape of `output_concat`:</span>
        <span class="c1"># (`batch_size`, no. of queries, `num_hiddens`)</span>
        <span class="n">output_concat</span> <span class="o">=</span> <span class="n">transpose_output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span><span class="p">(</span><span class="n">output_concat</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/multihead-attention.md</span>
<div class="viewcode-block" id="transpose_qkv"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.transpose_qkv">[docs]</a><span class="k">def</span> <span class="nf">transpose_qkv</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">):</span>
    <span class="sd">"""Transposition for parallel computation of multiple attention heads."""</span>
    <span class="c1"># Shape of input `X`:</span>
    <span class="c1"># (`batch_size`, no. of queries or key-value pairs, `num_hiddens`).</span>
    <span class="c1"># Shape of output `X`:</span>
    <span class="c1"># (`batch_size`, no. of queries or key-value pairs, `num_heads`,</span>
    <span class="c1"># `num_hiddens` / `num_heads`)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_heads</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Shape of output `X`:</span>
    <span class="c1"># (`batch_size`, `num_heads`, no. of queries or key-value pairs,</span>
    <span class="c1"># `num_hiddens` / `num_heads`)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Shape of `output`:</span>
    <span class="c1"># (`batch_size` * `num_heads`, no. of queries or key-value pairs,</span>
    <span class="c1"># `num_hiddens` / `num_heads`)</span>
    <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>


<div class="viewcode-block" id="transpose_output"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.transpose_output">[docs]</a><span class="k">def</span> <span class="nf">transpose_output</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">):</span>
    <span class="sd">"""Reverse the operation of `transpose_qkv`."""</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/self-attention-and-positional-encoding.md</span>
<div class="viewcode-block" id="PositionalEncoding"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.PositionalEncoding">[docs]</a><span class="k">class</span> <span class="nc">PositionalEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Positional encoding."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionalEncoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># Create a long enough `P`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
                <span class="mi">10000</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span>
                <span class="n">num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<div class="viewcode-block" id="PositionalEncoding.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.PositionalEncoding.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[:,</span> <span class="p">:</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/transformer.md</span>
<div class="viewcode-block" id="PositionWiseFFN"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.PositionWiseFFN">[docs]</a><span class="k">class</span> <span class="nc">PositionWiseFFN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Positionwise feed-forward network."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">ffn_num_outputs</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionWiseFFN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">ffn_num_outputs</span><span class="p">)</span>

<div class="viewcode-block" id="PositionWiseFFN.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.PositionWiseFFN.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/transformer.md</span>
<div class="viewcode-block" id="AddNorm"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.AddNorm">[docs]</a><span class="k">class</span> <span class="nc">AddNorm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Residual connection followed by layer normalization."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized_shape</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AddNorm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">normalized_shape</span><span class="p">)</span>

<div class="viewcode-block" id="AddNorm.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.AddNorm.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">+</span> <span class="n">X</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/transformer.md</span>
<div class="viewcode-block" id="EncoderBlock"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.EncoderBlock">[docs]</a><span class="k">class</span> <span class="nc">EncoderBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""Transformer encoder block."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span>
                 <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span>
                 <span class="n">dropout</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span>
                                                <span class="n">value_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span>
                                                <span class="n">num_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">use_bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addnorm1</span> <span class="o">=</span> <span class="n">AddNorm</span><span class="p">(</span><span class="n">norm_shape</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">PositionWiseFFN</span><span class="p">(</span><span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span>
                                   <span class="n">num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addnorm2</span> <span class="o">=</span> <span class="n">AddNorm</span><span class="p">(</span><span class="n">norm_shape</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>

<div class="viewcode-block" id="EncoderBlock.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.EncoderBlock.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addnorm1</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">addnorm2</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span></div></div>


<span class="c1"># Defined in file: ./chapter_attention-mechanisms/transformer.md</span>
<div class="viewcode-block" id="TransformerEncoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.TransformerEncoder">[docs]</a><span class="k">class</span> <span class="nc">TransformerEncoder</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">Encoder</span><span class="p">):</span>
    <span class="sd">"""Transformer encoder."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">,</span>
                 <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span>
                 <span class="n">num_heads</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TransformerEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span> <span class="o">=</span> <span class="n">num_hiddens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_encoding</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blks</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s2">"block"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                <span class="n">EncoderBlock</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span>
                             <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span>
                             <span class="n">num_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">use_bias</span><span class="p">))</span>

<div class="viewcode-block" id="TransformerEncoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.TransformerEncoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># Since positional encoding values are between -1 and 1, the embedding</span>
        <span class="c1"># values are multiplied by the square root of the embedding dimension</span>
        <span class="c1"># to rescale before they are summed up</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_encoding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">blk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blks</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">blk</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span><span class="p">[</span>
                <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">attention_weights</span>
        <span class="k">return</span> <span class="n">X</span></div></div>


<span class="c1"># Defined in file: ./chapter_optimization/optimization-intro.md</span>
<span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">xytext</span><span class="p">):</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="n">xytext</span><span class="p">,</span>
                           <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">'-&gt;'</span><span class="p">))</span>


<span class="c1"># Defined in file: ./chapter_optimization/gd.md</span>
<div class="viewcode-block" id="train_2d"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_2d">[docs]</a><span class="k">def</span> <span class="nf">train_2d</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">f_grad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Optimize a 2D objective function with a customized trainer."""</span>
    <span class="c1"># `s1` and `s2` are internal state variables that will be used later</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f_grad</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">f_grad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'epoch </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">, x1: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">, x2: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="show_trace_2d"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.show_trace_2d">[docs]</a><span class="k">def</span> <span class="nf">show_trace_2d</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">"""Show the trace of 2D variables during optimization."""</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">set_figsize</span><span class="p">()</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">),</span> <span class="s1">'-o'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#ff7f0e'</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                          <span class="n">d2l</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">'#1f77b4'</span><span class="p">)</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'x1'</span><span class="p">)</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'x2'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_optimization/minibatch-sgd.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'airfoil'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'airfoil_self_noise.dat'</span><span class="p">,</span>
                           <span class="s1">'76e5be1548fd8222e5074cf0faae75edff8cf93f'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data_ch11</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1500</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'airfoil'</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                         <span class="n">delimiter</span><span class="o">=</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">data_iter</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">load_array</span><span class="p">((</span><span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">batch_size</span><span class="p">,</span>
                               <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>


<span class="c1"># Defined in file: ./chapter_optimization/minibatch-sgd.md</span>
<span class="k">def</span> <span class="nf">train_ch11</span><span class="p">(</span><span class="n">trainer_fn</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">feature_dim</span><span class="p">,</span>
               <span class="n">num_epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># Initialization</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">feature_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">net</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">d2l</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">squared_loss</span>
    <span class="c1"># Train</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'loss'</span><span class="p">,</span>
                            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">trainer_fn</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">states</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_iter</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">evaluate_loss</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">),))</span>
                <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'loss: </span><span class="si">{</span><span class="n">animator</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">timer</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> sec/epoch'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timer</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">animator</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># Defined in file: ./chapter_optimization/minibatch-sgd.md</span>
<span class="k">def</span> <span class="nf">train_concise_ch11</span><span class="p">(</span><span class="n">trainer_fn</span><span class="p">,</span> <span class="n">hyperparams</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1"># Initialization</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">net</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">init_weights</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">trainer_fn</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="o">**</span><span class="n">hyperparams</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="c1"># Note: L2 Loss = 1/2 * MSE Loss. PyTorch has MSE Loss which is slightly</span>
    <span class="c1"># different from MXNet's L2Loss by a factor of 2. Hence we halve the loss</span>
    <span class="c1"># value to get L2Loss in PyTorch</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">'loss'</span><span class="p">,</span>
                            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_iter</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">evaluate_loss</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,))</span>
                <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'loss: </span><span class="si">{</span><span class="n">animator</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">timer</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> sec/epoch'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_computational-performance/hybridize.md</span>
<div class="viewcode-block" id="Benchmark"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.Benchmark">[docs]</a><span class="k">class</span> <span class="nc">Benchmark</span><span class="p">:</span>
    <span class="sd">"""For measuring running time."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">'Done'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> sec'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computational-performance/multiple-gpus.md</span>
<div class="viewcode-block" id="split_batch"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.split_batch">[docs]</a><span class="k">def</span> <span class="nf">split_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">devices</span><span class="p">):</span>
    <span class="sd">"""Split `X` and `y` into multiple devices."""</span>
    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">devices</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">devices</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_computational-performance/multiple-gpus-concise.md</span>
<div class="viewcode-block" id="resnet18"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.resnet18">[docs]</a><span class="k">def</span> <span class="nf">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""A slightly modified ResNet-18 model."""</span>
    <span class="k">def</span> <span class="nf">resnet_block</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">num_residuals</span><span class="p">,</span>
                     <span class="n">first_block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">blk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_residuals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_block</span><span class="p">:</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">d2l</span><span class="o">.</span><span class="n">Residual</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">use_1x1conv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">Residual</span><span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">)</span>

    <span class="c1"># This model uses a smaller convolution kernel, stride, and padding and</span>
    <span class="c1"># removes the maximum pooling layer</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"resnet_block1"</span><span class="p">,</span> <span class="n">resnet_block</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">first_block</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"resnet_block2"</span><span class="p">,</span> <span class="n">resnet_block</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"resnet_block3"</span><span class="p">,</span> <span class="n">resnet_block</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"resnet_block4"</span><span class="p">,</span> <span class="n">resnet_block</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"global_avg_pool"</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">"fc"</span><span class="p">,</span>
                   <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">net</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/image-augmentation.md</span>
<div class="viewcode-block" id="train_batch_ch13"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_batch_ch13">[docs]</a><span class="k">def</span> <span class="nf">train_batch_ch13</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">devices</span><span class="p">):</span>
    <span class="sd">"""Train for a minibatch with mutiple GPUs (defined in Chapter 13)."""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Required for BERT fine-tuning (to be covered later)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">train_loss_sum</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">train_acc_sum</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_loss_sum</span><span class="p">,</span> <span class="n">train_acc_sum</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/image-augmentation.md</span>
<div class="viewcode-block" id="train_ch13"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.train_ch13">[docs]</a><span class="k">def</span> <span class="nf">train_ch13</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span>
               <span class="n">devices</span><span class="o">=</span><span class="n">d2l</span><span class="o">.</span><span class="n">try_all_gpus</span><span class="p">()):</span>
    <span class="sd">"""Train a model with mutiple GPUs (defined in Chapter 13)."""</span>
    <span class="n">timer</span><span class="p">,</span> <span class="n">num_batches</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Timer</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_iter</span><span class="p">)</span>
    <span class="n">animator</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">'epoch'</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">'train loss'</span><span class="p">,</span> <span class="s1">'train acc'</span><span class="p">,</span> <span class="s1">'test acc'</span><span class="p">])</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="n">devices</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="c1"># Sum of training loss, sum of training accuracy, no. of examples,</span>
        <span class="c1"># no. of predictions</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_iter</span><span class="p">):</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">train_batch_ch13</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span>
                                      <span class="n">devices</span><span class="p">)</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_batches</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_batches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">epoch</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_batches</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">evaluate_accuracy_gpu</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
        <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'loss </span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, train acc '</span>
          <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, test acc </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_epochs</span> <span class="o">/</span> <span class="n">timer</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> examples/sec on '</span>
          <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/fine-tuning.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'hotdog'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'hotdog.zip'</span><span class="p">,</span>
                          <span class="s1">'fba480ffa8aa7e0febbb511d181409f899b9baa5'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_computer-vision/bounding-box.md</span>
<div class="viewcode-block" id="box_corner_to_center"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.box_corner_to_center">[docs]</a><span class="k">def</span> <span class="nf">box_corner_to_center</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="sd">"""Convert from (upper-left, lower-right) to (center, width, height)."""</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boxes</span></div>


<div class="viewcode-block" id="box_center_to_corner"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.box_center_to_corner">[docs]</a><span class="k">def</span> <span class="nf">box_center_to_corner</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="sd">"""Convert from (center, width, height) to (upper-left, lower-right)."""</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boxes</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/bounding-box.md</span>
<div class="viewcode-block" id="bbox_to_rect"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.bbox_to_rect">[docs]</a><span class="k">def</span> <span class="nf">bbox_to_rect</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">"""Convert bounding box to matplotlib format."""</span>
    <span class="c1"># Convert the bounding box (upper-left x, upper-left y, lower-right x,</span>
    <span class="c1"># lower-right y) format to the matplotlib format: ((upper-left x,</span>
    <span class="c1"># upper-left y), width, height)</span>
    <span class="k">return</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">height</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="multibox_prior"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.multibox_prior">[docs]</a><span class="k">def</span> <span class="nf">multibox_prior</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">ratios</span><span class="p">):</span>
    <span class="sd">"""Generate anchor boxes with different shapes centered on each pixel."""</span>
    <span class="n">in_height</span><span class="p">,</span> <span class="n">in_width</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">device</span><span class="p">,</span> <span class="n">num_sizes</span><span class="p">,</span> <span class="n">num_ratios</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
    <span class="n">boxes_per_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_sizes</span> <span class="o">+</span> <span class="n">num_ratios</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">size_tensor</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ratio_tensor</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Offsets are required to move the anchor to the center of a pixel. Since</span>
    <span class="c1"># a pixel has height=1 and width=1, we choose to offset our centers by 0.5</span>
    <span class="n">offset_h</span><span class="p">,</span> <span class="n">offset_w</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span>
    <span class="n">steps_h</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">in_height</span>  <span class="c1"># Scaled steps in y axis</span>
    <span class="n">steps_w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">in_width</span>  <span class="c1"># Scaled steps in x axis</span>

    <span class="c1"># Generate all center points for the anchor boxes</span>
    <span class="n">center_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">in_height</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_h</span><span class="p">)</span> <span class="o">*</span> <span class="n">steps_h</span>
    <span class="n">center_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">in_width</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_w</span><span class="p">)</span> <span class="o">*</span> <span class="n">steps_w</span>
    <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">center_h</span><span class="p">,</span> <span class="n">center_w</span><span class="p">)</span>
    <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span> <span class="o">=</span> <span class="n">shift_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">shift_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Generate `boxes_per_pixel` number of heights and widths that are later</span>
    <span class="c1"># used to create anchor box corner coordinates (xmin, xmax, ymin, ymax)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">size_tensor</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                   <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>\
                   <span class="o">*</span> <span class="n">in_height</span> <span class="o">/</span> <span class="n">in_width</span>  <span class="c1"># Handle rectangular inputs</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">size_tensor</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                   <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
    <span class="c1"># Divide by 2 to get half height and half width</span>
    <span class="n">anchor_manipulations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">in_height</span> <span class="o">*</span> <span class="n">in_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Each center point will have `boxes_per_pixel` number of anchor boxes, so</span>
    <span class="c1"># generate a grid of all anchor box centers with `boxes_per_pixel` repeats</span>
    <span class="n">out_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">],</span>
                           <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">boxes_per_pixel</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">out_grid</span> <span class="o">+</span> <span class="n">anchor_manipulations</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="show_bboxes"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.show_bboxes">[docs]</a><span class="k">def</span> <span class="nf">show_bboxes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Show bounding boxes."""</span>
    <span class="k">def</span> <span class="nf">make_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">default_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">default_values</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">make_list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">make_list</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="p">[</span><span class="s1">'b'</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="s1">'m'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bboxes</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">bbox_to_rect</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span> <span class="n">color</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">text_color</span> <span class="o">=</span> <span class="s1">'k'</span> <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">'w'</span> <span class="k">else</span> <span class="s1">'w'</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">va</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span>
                      <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">text_color</span><span class="p">,</span>
                      <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="box_iou"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.box_iou">[docs]</a><span class="k">def</span> <span class="nf">box_iou</span><span class="p">(</span><span class="n">boxes1</span><span class="p">,</span> <span class="n">boxes2</span><span class="p">):</span>
    <span class="sd">"""Compute pairwise IoU across two lists of anchor or bounding boxes."""</span>
    <span class="n">box_area</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">boxes</span><span class="p">:</span> <span class="p">((</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
                              <span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># Shape of `boxes1`, `boxes2`, `areas1`, `areas2`: (no. of boxes1, 4),</span>
    <span class="c1"># (no. of boxes2, 4), (no. of boxes1,), (no. of boxes2,)</span>
    <span class="n">areas1</span> <span class="o">=</span> <span class="n">box_area</span><span class="p">(</span><span class="n">boxes1</span><span class="p">)</span>
    <span class="n">areas2</span> <span class="o">=</span> <span class="n">box_area</span><span class="p">(</span><span class="n">boxes2</span><span class="p">)</span>
    <span class="c1"># Shape of `inter_upperlefts`, `inter_lowerrights`, `inters`: (no. of</span>
    <span class="c1"># boxes1, no. of boxes2, 2)</span>
    <span class="n">inter_upperlefts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">inter_lowerrights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">inters</span> <span class="o">=</span> <span class="p">(</span><span class="n">inter_lowerrights</span> <span class="o">-</span> <span class="n">inter_upperlefts</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Shape of `inter_areas` and `union_areas`: (no. of boxes1, no. of boxes2)</span>
    <span class="n">inter_areas</span> <span class="o">=</span> <span class="n">inters</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inters</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">union_areas</span> <span class="o">=</span> <span class="n">areas1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">areas2</span> <span class="o">-</span> <span class="n">inter_areas</span>
    <span class="k">return</span> <span class="n">inter_areas</span> <span class="o">/</span> <span class="n">union_areas</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="assign_anchor_to_bbox"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.assign_anchor_to_bbox">[docs]</a><span class="k">def</span> <span class="nf">assign_anchor_to_bbox</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">"""Assign closest ground-truth bounding boxes to anchor boxes."""</span>
    <span class="n">num_anchors</span><span class="p">,</span> <span class="n">num_gt_boxes</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Element x_ij in the i-th row and j-th column is the IoU of the anchor</span>
    <span class="c1"># box i and the ground-truth bounding box j</span>
    <span class="n">jaccard</span> <span class="o">=</span> <span class="n">box_iou</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span>
    <span class="c1"># Initialize the tensor to hold the assigned ground-truth bounding box for</span>
    <span class="c1"># each anchor</span>
    <span class="n">anchors_bbox_map</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_anchors</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span>
                                  <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Assign ground-truth bounding boxes according to the threshold</span>
    <span class="n">max_ious</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">jaccard</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">anc_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">max_ious</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">box_j</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">max_ious</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">anchors_bbox_map</span><span class="p">[</span><span class="n">anc_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_j</span>
    <span class="n">col_discard</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_anchors</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">row_discard</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_gt_boxes</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gt_boxes</span><span class="p">):</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">jaccard</span><span class="p">)</span>  <span class="c1"># Find the largest IoU</span>
        <span class="n">box_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_idx</span> <span class="o">%</span> <span class="n">num_gt_boxes</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="n">anc_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_idx</span> <span class="o">/</span> <span class="n">num_gt_boxes</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="n">anchors_bbox_map</span><span class="p">[</span><span class="n">anc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_idx</span>
        <span class="n">jaccard</span><span class="p">[:,</span> <span class="n">box_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_discard</span>
        <span class="n">jaccard</span><span class="p">[</span><span class="n">anc_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">row_discard</span>
    <span class="k">return</span> <span class="n">anchors_bbox_map</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="offset_boxes"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.offset_boxes">[docs]</a><span class="k">def</span> <span class="nf">offset_boxes</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">assigned_bb</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">"""Transform for anchor box offsets."""</span>
    <span class="n">c_anc</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">box_corner_to_center</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
    <span class="n">c_assigned_bb</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">box_corner_to_center</span><span class="p">(</span><span class="n">assigned_bb</span><span class="p">)</span>
    <span class="n">offset_xy</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_assigned_bb</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">c_anc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">c_anc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
    <span class="n">offset_wh</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">d2l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eps</span> <span class="o">+</span> <span class="n">c_assigned_bb</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">/</span> <span class="n">c_anc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">offset_xy</span><span class="p">,</span> <span class="n">offset_wh</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">offset</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="multibox_target"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.multibox_target">[docs]</a><span class="k">def</span> <span class="nf">multibox_target</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">"""Label anchor boxes using ground-truth bounding boxes."""</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchors</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">batch_offset</span><span class="p">,</span> <span class="n">batch_mask</span><span class="p">,</span> <span class="n">batch_class_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">device</span><span class="p">,</span> <span class="n">num_anchors</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">anchors_bbox_map</span> <span class="o">=</span> <span class="n">assign_anchor_to_bbox</span><span class="p">(</span><span class="n">label</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">anchors</span><span class="p">,</span>
                                                 <span class="n">device</span><span class="p">)</span>
        <span class="n">bbox_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">anchors_bbox_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c1"># Initialize class labels and assigned bounding box coordinates with</span>
        <span class="c1"># zeros</span>
        <span class="n">class_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span>
                                   <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">assigned_bb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_anchors</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                  <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># Label classes of anchor boxes using their assigned ground-truth</span>
        <span class="c1"># bounding boxes. If an anchor box is not assigned any, we label its</span>
        <span class="c1"># class as background (the value remains zero)</span>
        <span class="n">indices_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">anchors_bbox_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bb_idx</span> <span class="o">=</span> <span class="n">anchors_bbox_map</span><span class="p">[</span><span class="n">indices_true</span><span class="p">]</span>
        <span class="n">class_labels</span><span class="p">[</span><span class="n">indices_true</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">bb_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">assigned_bb</span><span class="p">[</span><span class="n">indices_true</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">bb_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># Offset transformation</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_boxes</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">assigned_bb</span><span class="p">)</span> <span class="o">*</span> <span class="n">bbox_mask</span>
        <span class="n">batch_offset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">batch_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bbox_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">batch_class_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_labels</span><span class="p">)</span>
    <span class="n">bbox_offset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_offset</span><span class="p">)</span>
    <span class="n">bbox_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_mask</span><span class="p">)</span>
    <span class="n">class_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_class_labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bbox_offset</span><span class="p">,</span> <span class="n">bbox_mask</span><span class="p">,</span> <span class="n">class_labels</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="offset_inverse"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.offset_inverse">[docs]</a><span class="k">def</span> <span class="nf">offset_inverse</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">offset_preds</span><span class="p">):</span>
    <span class="sd">"""Predict bounding boxes based on anchor boxes with predicted offsets."""</span>
    <span class="n">anc</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">box_corner_to_center</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
    <span class="n">pred_bbox_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset_preds</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">anc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">anc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pred_bbox_wh</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">offset_preds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">anc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
    <span class="n">pred_bbox</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pred_bbox_xy</span><span class="p">,</span> <span class="n">pred_bbox_wh</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">predicted_bbox</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">box_center_to_corner</span><span class="p">(</span><span class="n">pred_bbox</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predicted_bbox</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="nms"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.nms">[docs]</a><span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">):</span>
    <span class="sd">"""Sort confidence scores of predicted bounding boxes."""</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Indices of predicted bounding boxes that will be kept</span>
    <span class="k">while</span> <span class="n">B</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">B</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="n">box_iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                      <span class="n">boxes</span><span class="p">[</span><span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">iou</span> <span class="o">&lt;=</span> <span class="n">iou_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">inds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">boxes</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/anchor.md</span>
<div class="viewcode-block" id="multibox_detection"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.multibox_detection">[docs]</a><span class="k">def</span> <span class="nf">multibox_detection</span><span class="p">(</span><span class="n">cls_probs</span><span class="p">,</span> <span class="n">offset_preds</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                       <span class="n">pos_threshold</span><span class="o">=</span><span class="mf">0.009999999</span><span class="p">):</span>
    <span class="sd">"""Predict bounding boxes using non-maximum suppression."""</span>
    <span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">cls_probs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">cls_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">num_classes</span><span class="p">,</span> <span class="n">num_anchors</span> <span class="o">=</span> <span class="n">cls_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cls_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">cls_prob</span><span class="p">,</span> <span class="n">offset_pred</span> <span class="o">=</span> <span class="n">cls_probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">offset_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">conf</span><span class="p">,</span> <span class="n">class_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cls_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">predicted_bb</span> <span class="o">=</span> <span class="n">offset_inverse</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">offset_pred</span><span class="p">)</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">predicted_bb</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="p">)</span>
        <span class="c1"># Find all non-`keep` indices and set the class to background</span>
        <span class="n">all_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">keep</span><span class="p">,</span> <span class="n">all_idx</span><span class="p">))</span>
        <span class="n">uniques</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">non_keep</span> <span class="o">=</span> <span class="n">uniques</span><span class="p">[</span><span class="n">counts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">all_id_sorted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">keep</span><span class="p">,</span> <span class="n">non_keep</span><span class="p">))</span>
        <span class="n">class_id</span><span class="p">[</span><span class="n">non_keep</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">class_id</span> <span class="o">=</span> <span class="n">class_id</span><span class="p">[</span><span class="n">all_id_sorted</span><span class="p">]</span>
        <span class="n">conf</span><span class="p">,</span> <span class="n">predicted_bb</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="n">all_id_sorted</span><span class="p">],</span> <span class="n">predicted_bb</span><span class="p">[</span><span class="n">all_id_sorted</span><span class="p">]</span>
        <span class="c1"># Here `pos_threshold` is a threshold for positive (non-background)</span>
        <span class="c1"># predictions</span>
        <span class="n">below_min_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&lt;</span> <span class="n">pos_threshold</span><span class="p">)</span>
        <span class="n">class_id</span><span class="p">[</span><span class="n">below_min_idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">conf</span><span class="p">[</span><span class="n">below_min_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span><span class="p">[</span><span class="n">below_min_idx</span><span class="p">]</span>
        <span class="n">pred_info</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">class_id</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">conf</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">predicted_bb</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d2l</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/object-detection-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'banana-detection'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'banana-detection.zip'</span><span class="p">,</span>
    <span class="s1">'5de26c8fce5ccdea9f91267273464dc968d20d72'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_computer-vision/object-detection-dataset.md</span>
<div class="viewcode-block" id="read_data_bananas"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_data_bananas">[docs]</a><span class="k">def</span> <span class="nf">read_data_bananas</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Read the banana detection dataset images and labels."""</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'banana-detection'</span><span class="p">)</span>
    <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>
                             <span class="s1">'bananas_train'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s1">'bananas_val'</span><span class="p">,</span>
                             <span class="s1">'label.csv'</span><span class="p">)</span>
    <span class="n">csv_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">)</span>
    <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'img_name'</span><span class="p">)</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">img_name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>
                             <span class="s1">'bananas_train'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s1">'bananas_val'</span><span class="p">,</span>
                             <span class="s1">'images'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">img_name</span><span class="si">}</span><span class="s1">'</span><span class="p">)))</span>
        <span class="c1"># Here `target` contains (class, upper-left x, upper-left y,</span>
        <span class="c1"># lower-right x, lower-right y), where all the images have the same</span>
        <span class="c1"># banana class (index 0)</span>
        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/object-detection-dataset.md</span>
<div class="viewcode-block" id="BananasDataset"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.BananasDataset">[docs]</a><span class="k">class</span> <span class="nc">BananasDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">"""A customized dataset to load the banana detection dataset."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">read_data_bananas</span><span class="p">(</span><span class="n">is_train</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'read '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">' training examples'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">' validation examples'</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/object-detection-dataset.md</span>
<div class="viewcode-block" id="load_data_bananas"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_bananas">[docs]</a><span class="k">def</span> <span class="nf">load_data_bananas</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
    <span class="sd">"""Load the banana detection dataset."""</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">BananasDataset</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                             <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">val_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">BananasDataset</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                           <span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">val_iter</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'voc2012'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'VOCtrainval_11-May-2012.tar'</span><span class="p">,</span>
                           <span class="s1">'4e443f8a2eca6b1dac8a6c57641b67dd40621a49'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<div class="viewcode-block" id="read_voc_images"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_voc_images">[docs]</a><span class="k">def</span> <span class="nf">read_voc_images</span><span class="p">(</span><span class="n">voc_dir</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Read all VOC feature and label images."""</span>
    <span class="n">txt_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">voc_dir</span><span class="p">,</span> <span class="s1">'ImageSets'</span><span class="p">,</span> <span class="s1">'Segmentation'</span><span class="p">,</span>
                             <span class="s1">'train.txt'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s1">'val.txt'</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageReadMode</span><span class="o">.</span><span class="n">RGB</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_fname</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">voc_dir</span><span class="p">,</span> <span class="s1">'JPEGImages'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.jpg'</span><span class="p">)))</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">voc_dir</span><span class="p">,</span> <span class="s1">'SegmentationClass'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">.png'</span><span class="p">),</span>
                <span class="n">mode</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<span class="n">VOC_COLORMAP</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]]</span>

<span class="n">VOC_CLASSES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'background'</span><span class="p">,</span> <span class="s1">'aeroplane'</span><span class="p">,</span> <span class="s1">'bicycle'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span> <span class="s1">'boat'</span><span class="p">,</span> <span class="s1">'bottle'</span><span class="p">,</span> <span class="s1">'bus'</span><span class="p">,</span>
    <span class="s1">'car'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'chair'</span><span class="p">,</span> <span class="s1">'cow'</span><span class="p">,</span> <span class="s1">'diningtable'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'horse'</span><span class="p">,</span> <span class="s1">'motorbike'</span><span class="p">,</span>
    <span class="s1">'person'</span><span class="p">,</span> <span class="s1">'potted plant'</span><span class="p">,</span> <span class="s1">'sheep'</span><span class="p">,</span> <span class="s1">'sofa'</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">,</span> <span class="s1">'tv/monitor'</span><span class="p">]</span>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<div class="viewcode-block" id="voc_colormap2label"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.voc_colormap2label">[docs]</a><span class="k">def</span> <span class="nf">voc_colormap2label</span><span class="p">():</span>
    <span class="sd">"""Build the mapping from RGB to class indices for VOC labels."""</span>
    <span class="n">colormap2label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">256</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colormap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VOC_COLORMAP</span><span class="p">):</span>
        <span class="n">colormap2label</span><span class="p">[(</span><span class="n">colormap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span>
                       <span class="n">colormap</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">colormap2label</span></div>


<div class="viewcode-block" id="voc_label_indices"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.voc_label_indices">[docs]</a><span class="k">def</span> <span class="nf">voc_label_indices</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">colormap2label</span><span class="p">):</span>
    <span class="sd">"""Map any RGB values in VOC labels to their class indices."""</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">colormap</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">colormap</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span>
           <span class="n">colormap</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">colormap2label</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<div class="viewcode-block" id="voc_rand_crop"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.voc_rand_crop">[docs]</a><span class="k">def</span> <span class="nf">voc_rand_crop</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="sd">"""Randomly crop both feature and label images."""</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandomCrop</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span>
        <span class="n">feature</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feature</span><span class="p">,</span> <span class="n">label</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<div class="viewcode-block" id="VOCSegDataset"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.VOCSegDataset">[docs]</a><span class="k">class</span> <span class="nc">VOCSegDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">"""A customized dataset to load the VOC dataset."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">voc_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">=</span> <span class="n">crop_size</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">read_voc_images</span><span class="p">(</span><span class="n">voc_dir</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="n">is_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize_image</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">features</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colormap2label</span> <span class="o">=</span> <span class="n">voc_colormap2label</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'read '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">))</span> <span class="o">+</span> <span class="s1">' examples'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span> <span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                                    <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">feature</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">voc_rand_crop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                       <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">voc_label_indices</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap2label</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/semantic-segmentation-and-dataset.md</span>
<div class="viewcode-block" id="load_data_voc"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_voc">[docs]</a><span class="k">def</span> <span class="nf">load_data_voc</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">):</span>
    <span class="sd">"""Load the VOC semantic segmentation dataset."""</span>
    <span class="n">voc_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'voc2012'</span><span class="p">,</span>
                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'VOCdevkit'</span><span class="p">,</span> <span class="s1">'VOC2012'</span><span class="p">))</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_dataloader_workers</span><span class="p">()</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">VOCSegDataset</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">voc_dir</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="n">test_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">VOCSegDataset</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">voc_dir</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/kaggle-cifar10.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'cifar10_tiny'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'kaggle_cifar10_tiny.zip'</span><span class="p">,</span>
                                <span class="s1">'2068874e4b9a9f0fb07ebe0ad2b29754449ccacd'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_computer-vision/kaggle-cifar10.md</span>
<div class="viewcode-block" id="read_csv_labels"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_csv_labels">[docs]</a><span class="k">def</span> <span class="nf">read_csv_labels</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">"""Read `fname` to return a filename to label dictionary."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Skip the file header line (column name)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/kaggle-cifar10.md</span>
<div class="viewcode-block" id="copyfile"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.copyfile">[docs]</a><span class="k">def</span> <span class="nf">copyfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">):</span>
    <span class="sd">"""Copy a file into a target directory."""</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="reorg_train_valid"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.reorg_train_valid">[docs]</a><span class="k">def</span> <span class="nf">reorg_train_valid</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">valid_ratio</span><span class="p">):</span>
    <span class="sd">"""Split the validation set out of the original training set."""</span>
    <span class="c1"># The number of examples of the class that has the fewest examples in the</span>
    <span class="c1"># training dataset</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># The number of examples per class for the validation set</span>
    <span class="n">n_valid_per_label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">valid_ratio</span><span class="p">))</span>
    <span class="n">label_count</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">train_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">)):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">train_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">,</span> <span class="n">train_file</span><span class="p">)</span>
        <span class="n">copyfile</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train_valid_test'</span><span class="p">,</span> <span class="s1">'train_valid'</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_count</span> <span class="ow">or</span> <span class="n">label_count</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_valid_per_label</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train_valid_test'</span><span class="p">,</span> <span class="s1">'valid'</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="n">label_count</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train_valid_test'</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">n_valid_per_label</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/kaggle-cifar10.md</span>
<div class="viewcode-block" id="reorg_test"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.reorg_test">[docs]</a><span class="k">def</span> <span class="nf">reorg_test</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="sd">"""Organize the testing set for data loading during prediction."""</span>
    <span class="k">for</span> <span class="n">test_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">)):</span>
        <span class="n">copyfile</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">,</span> <span class="n">test_file</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train_valid_test'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_computer-vision/kaggle-dog.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'dog_tiny'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'kaggle_dog_tiny.zip'</span><span class="p">,</span>
                            <span class="s1">'0cb91d09b814ecdc07b50f31f8dcad3e81d6a86d'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'ptb'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'ptb.zip'</span><span class="p">,</span>
                       <span class="s1">'319d85e578af0cdc590547f26231e4e31cdf1e42'</span><span class="p">)</span>


<div class="viewcode-block" id="read_ptb"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_ptb">[docs]</a><span class="k">def</span> <span class="nf">read_ptb</span><span class="p">():</span>
    <span class="sd">"""Load the PTB dataset into a list of text lines."""</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'ptb'</span><span class="p">)</span>
    <span class="c1"># Read the training set.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'ptb.train.txt'</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">raw_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)]</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="subsample"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.subsample">[docs]</a><span class="k">def</span> <span class="nf">subsample</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="sd">"""Subsample high-frequency words."""</span>
    <span class="c1"># Exclude unknown tokens '&lt;unk&gt;'</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="n">vocab</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">unk</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">count_corpus</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
    <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Return True if `token` is kept during subsampling</span>
    <span class="k">def</span> <span class="nf">keep</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="mf">1e-4</span> <span class="o">/</span> <span class="n">counter</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tokens</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">([[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="n">keep</span><span class="p">(</span><span class="n">token</span><span class="p">)]</span>
             <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">],</span> <span class="n">counter</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="get_centers_and_contexts"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.get_centers_and_contexts">[docs]</a><span class="k">def</span> <span class="nf">get_centers_and_contexts</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">max_window_size</span><span class="p">):</span>
    <span class="sd">"""Return center words and context words in skip-gram."""</span>
    <span class="n">centers</span><span class="p">,</span> <span class="n">contexts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">corpus</span><span class="p">:</span>
        <span class="c1"># To form a "center word--context word" pair, each sentence needs to</span>
        <span class="c1"># have at least 2 words</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">centers</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>  <span class="c1"># Context window centered at `i`</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_window_size</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">),</span>
                      <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">)))</span>
            <span class="c1"># Exclude the center word from the context words</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">centers</span><span class="p">,</span> <span class="n">contexts</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="RandomGenerator"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.RandomGenerator">[docs]</a><span class="k">class</span> <span class="nc">RandomGenerator</span><span class="p">:</span>
    <span class="sd">"""Randomly draw among {1, ..., n} according to n sampling weights."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampling_weights</span><span class="p">):</span>
        <span class="c1"># Exclude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sampling_weights</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_weights</span> <span class="o">=</span> <span class="n">sampling_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidates</span><span class="p">):</span>
            <span class="c1"># Cache `k` random sampling results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">sampling_weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="get_negatives"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.get_negatives">[docs]</a><span class="k">def</span> <span class="nf">get_negatives</span><span class="p">(</span><span class="n">all_contexts</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="sd">"""Return noise words in negative sampling."""</span>
    <span class="c1"># Sampling weights for words with indices 1, 2, ... (index 0 is the</span>
    <span class="c1"># excluded unknown token) in the vocabulary</span>
    <span class="n">sampling_weights</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">counter</span><span class="p">[</span><span class="n">vocab</span><span class="o">.</span><span class="n">to_tokens</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">**</span><span class="mf">0.75</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">))]</span>
    <span class="n">all_negatives</span><span class="p">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">RandomGenerator</span><span class="p">(</span><span class="n">sampling_weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">contexts</span> <span class="ow">in</span> <span class="n">all_contexts</span><span class="p">:</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">negatives</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">contexts</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">:</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="c1"># Noise words cannot be context words</span>
            <span class="k">if</span> <span class="n">neg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">:</span>
                <span class="n">negatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span>
        <span class="n">all_negatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">negatives</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_negatives</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="batchify"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.batchify">[docs]</a><span class="k">def</span> <span class="nf">batchify</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">"""Return a minibatch of examples for skip-gram with negative sampling."""</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">centers</span><span class="p">,</span> <span class="n">contexts_negatives</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">center</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">negative</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">cur_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span>
        <span class="n">centers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">center</span><span class="p">]</span>
        <span class="n">contexts_negatives</span> <span class="o">+=</span> <span class="p">[</span><span class="n">context</span> <span class="o">+</span> <span class="n">negative</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="n">cur_len</span><span class="p">)]</span>
        <span class="n">masks</span> <span class="o">+=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cur_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="n">cur_len</span><span class="p">)]</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">))]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">centers</span><span class="p">),</span>
                        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">contexts_negatives</span><span class="p">),</span>
            <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">masks</span><span class="p">),</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/word-embedding-dataset.md</span>
<div class="viewcode-block" id="load_data_ptb"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_ptb">[docs]</a><span class="k">def</span> <span class="nf">load_data_ptb</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_window_size</span><span class="p">,</span> <span class="n">num_noise_words</span><span class="p">):</span>
    <span class="sd">"""Download the PTB dataset and then load it into memory."""</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_dataloader_workers</span><span class="p">()</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">read_ptb</span><span class="p">()</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">subsampled</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">subsample</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">vocab</span><span class="p">)</span>
    <span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">subsampled</span><span class="p">]</span>
    <span class="n">all_centers</span><span class="p">,</span> <span class="n">all_contexts</span> <span class="o">=</span> <span class="n">get_centers_and_contexts</span><span class="p">(</span>
        <span class="n">corpus</span><span class="p">,</span> <span class="n">max_window_size</span><span class="p">)</span>
    <span class="n">all_negatives</span> <span class="o">=</span> <span class="n">get_negatives</span><span class="p">(</span><span class="n">all_contexts</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span>
                                  <span class="n">num_noise_words</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">PTBDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">contexts</span><span class="p">,</span> <span class="n">negatives</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">contexts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">negatives</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="o">=</span> <span class="n">centers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span> <span class="o">=</span> <span class="n">contexts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span> <span class="o">=</span> <span class="n">negatives</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">PTBDataset</span><span class="p">(</span><span class="n">all_centers</span><span class="p">,</span> <span class="n">all_contexts</span><span class="p">,</span> <span class="n">all_negatives</span><span class="p">)</span>

    <span class="n">data_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">collate_fn</span><span class="o">=</span><span class="n">batchify</span><span class="p">,</span>
                                            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/similarity-analogy.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'glove.6b.50d'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'glove.6B.50d.zip'</span><span class="p">,</span>
                                <span class="s1">'0b8703943ccdb6eb788e6f091b8946e82231bc4d'</span><span class="p">)</span>

<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'glove.6b.100d'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'glove.6B.100d.zip'</span><span class="p">,</span>
                                 <span class="s1">'cd43bfb07e44e6f27cbcc7bc9ae3d80284fdaf5a'</span><span class="p">)</span>

<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'glove.42b.300d'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'glove.42B.300d.zip'</span><span class="p">,</span>
                                  <span class="s1">'b5116e234e9eb9076672cfeabf5469f3eec904fa'</span><span class="p">)</span>

<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'wiki.en'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'wiki.en.zip'</span><span class="p">,</span>
                           <span class="s1">'c1816da3821ae9f43899be655002f6c723e91b88'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/similarity-analogy.md</span>
<div class="viewcode-block" id="TokenEmbedding"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.TokenEmbedding">[docs]</a><span class="k">class</span> <span class="nc">TokenEmbedding</span><span class="p">:</span>
    <span class="sd">"""Token Embedding."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_embedding</span><span class="p">(</span>
            <span class="n">embedding_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unknown_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_load_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_name</span><span class="p">):</span>
        <span class="n">idx_to_token</span><span class="p">,</span> <span class="n">idx_to_vec</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'&lt;unk&gt;'</span><span class="p">],</span> <span class="p">[]</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="n">embedding_name</span><span class="p">)</span>
        <span class="c1"># GloVe website: https://nlp.stanford.edu/projects/glove/</span>
        <span class="c1"># fastText website: https://fasttext.cc/</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'vec.txt'</span><span class="p">),</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">elems</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">elems</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="c1"># Skip header information, such as the top row in fastText</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">idx_to_token</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="n">idx_to_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">idx_to_vec</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_to_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">+</span> <span class="n">idx_to_vec</span>
        <span class="k">return</span> <span class="n">idx_to_token</span><span class="p">,</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idx_to_vec</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_idx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_vec</span><span class="p">[</span><span class="n">d2l</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">vecs</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert.md</span>
<div class="viewcode-block" id="get_tokens_and_segments"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.get_tokens_and_segments">[docs]</a><span class="k">def</span> <span class="nf">get_tokens_and_segments</span><span class="p">(</span><span class="n">tokens_a</span><span class="p">,</span> <span class="n">tokens_b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Get tokens of the BERT input sequence and their segment IDs."""</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'&lt;cls&gt;'</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens_a</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'&lt;sep&gt;'</span><span class="p">]</span>
    <span class="c1"># 0 and 1 are marking segment A and B, respectively</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens_a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokens_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">+=</span> <span class="n">tokens_b</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'&lt;sep&gt;'</span><span class="p">]</span>
        <span class="n">segments</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens_b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert.md</span>
<div class="viewcode-block" id="BERTEncoder"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.BERTEncoder">[docs]</a><span class="k">class</span> <span class="nc">BERTEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""BERT encoder."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span>
                 <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span>
                 <span class="n">max_len</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">key_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">query_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">value_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BERTEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blks</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="n">d2l</span><span class="o">.</span><span class="n">EncoderBlock</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">,</span>
                                 <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span>
                                 <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="c1"># In BERT, positional embeddings are learnable, thus we create a</span>
        <span class="c1"># parameter of positional embeddings that are long enough</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span>
                                                      <span class="n">num_hiddens</span><span class="p">))</span>

<div class="viewcode-block" id="BERTEncoder.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.BERTEncoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">):</span>
        <span class="c1"># Shape of `X` remains unchanged in the following code snippet:</span>
        <span class="c1"># (batch size, max sequence length, `num_hiddens`)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_embedding</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_embedding</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embedding</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blks</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">blk</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert.md</span>
<div class="viewcode-block" id="MaskLM"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MaskLM">[docs]</a><span class="k">class</span> <span class="nc">MaskLM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The masked language model task of BERT."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_inputs</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MaskLM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">),</span>
                                 <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">num_hiddens</span><span class="p">),</span>
                                 <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_hiddens</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">))</span>

<div class="viewcode-block" id="MaskLM.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.MaskLM.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">pred_positions</span><span class="p">):</span>
        <span class="n">num_pred_positions</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pred_positions</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># Suppose that `batch_size` = 2, `num_pred_positions` = 3, then</span>
        <span class="c1"># `batch_idx` is `torch.tensor([0, 0, 0, 1, 1, 1])`</span>
        <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">num_pred_positions</span><span class="p">)</span>
        <span class="n">masked_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">pred_positions</span><span class="p">]</span>
        <span class="n">masked_X</span> <span class="o">=</span> <span class="n">masked_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_pred_positions</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">mlm_Y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">masked_X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mlm_Y_hat</span></div></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert.md</span>
<div class="viewcode-block" id="NextSentencePred"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.NextSentencePred">[docs]</a><span class="k">class</span> <span class="nc">NextSentencePred</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The next sentence prediction task of BERT."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NextSentencePred</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_inputs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="NextSentencePred.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.NextSentencePred.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># `X` shape: (batch size, `num_hiddens`)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert.md</span>
<div class="viewcode-block" id="BERTModel"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.BERTModel">[docs]</a><span class="k">class</span> <span class="nc">BERTModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""The BERT model."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">norm_shape</span><span class="p">,</span> <span class="n">ffn_num_input</span><span class="p">,</span>
                 <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span>
                 <span class="n">max_len</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">key_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">query_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">value_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
                 <span class="n">hid_in_features</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">mlm_in_features</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
                 <span class="n">nsp_in_features</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BERTModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">BERTEncoder</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">norm_shape</span><span class="p">,</span>
                                   <span class="n">ffn_num_input</span><span class="p">,</span> <span class="n">ffn_num_hiddens</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span>
                                   <span class="n">num_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
                                   <span class="n">key_size</span><span class="o">=</span><span class="n">key_size</span><span class="p">,</span> <span class="n">query_size</span><span class="o">=</span><span class="n">query_size</span><span class="p">,</span>
                                   <span class="n">value_size</span><span class="o">=</span><span class="n">value_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hid_in_features</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">),</span>
                                    <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlm</span> <span class="o">=</span> <span class="n">MaskLM</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">mlm_in_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsp</span> <span class="o">=</span> <span class="n">NextSentencePred</span><span class="p">(</span><span class="n">nsp_in_features</span><span class="p">)</span>

<div class="viewcode-block" id="BERTModel.forward"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.BERTModel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">valid_lens</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pred_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">encoded_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pred_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlm_Y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlm</span><span class="p">(</span><span class="n">encoded_X</span><span class="p">,</span> <span class="n">pred_positions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlm_Y_hat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The hidden layer of the MLP classifier for next sentence prediction.</span>
        <span class="c1"># 0 is the index of the '&lt;cls&gt;' token</span>
        <span class="n">nsp_Y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">(</span><span class="n">encoded_X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">encoded_X</span><span class="p">,</span> <span class="n">mlm_Y_hat</span><span class="p">,</span> <span class="n">nsp_Y_hat</span></div></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'wikitext-2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'https://s3.amazonaws.com/research.metamind.io/wikitext/'</span>
    <span class="s1">'wikitext-2-v1.zip'</span><span class="p">,</span> <span class="s1">'3c914d17d80b1459be871a5039ac23e752a53cbe'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_read_wiki</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'wiki.train.tokens'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="c1"># Uppercase letters are converted to lowercase ones</span>
    <span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' . '</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' . '</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paragraphs</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">def</span> <span class="nf">_get_next_sentence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">next_sentence</span><span class="p">,</span> <span class="n">paragraphs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">is_next</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># `paragraphs` is a list of lists of lists</span>
        <span class="n">next_sentence</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">))</span>
        <span class="n">is_next</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">next_sentence</span><span class="p">,</span> <span class="n">is_next</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">def</span> <span class="nf">_get_nsp_data_from_paragraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">,</span> <span class="n">paragraphs</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">max_len</span><span class="p">):</span>
    <span class="n">nsp_data_from_paragraph</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paragraph</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">tokens_a</span><span class="p">,</span> <span class="n">tokens_b</span><span class="p">,</span> <span class="n">is_next</span> <span class="o">=</span> <span class="n">_get_next_sentence</span><span class="p">(</span>
            <span class="n">paragraph</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">paragraph</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">paragraphs</span><span class="p">)</span>
        <span class="c1"># Consider 1 '&lt;cls&gt;' token and 2 '&lt;sep&gt;' tokens</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens_a</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens_b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_tokens_and_segments</span><span class="p">(</span><span class="n">tokens_a</span><span class="p">,</span> <span class="n">tokens_b</span><span class="p">)</span>
        <span class="n">nsp_data_from_paragraph</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">is_next</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nsp_data_from_paragraph</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">def</span> <span class="nf">_replace_mlm_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">candidate_pred_positions</span><span class="p">,</span> <span class="n">num_mlm_preds</span><span class="p">,</span>
                        <span class="n">vocab</span><span class="p">):</span>
    <span class="c1"># Make a new copy of tokens for the input of a masked language model,</span>
    <span class="c1"># where the input may contain replaced '&lt;mask&gt;' or random tokens</span>
    <span class="n">mlm_input_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="n">pred_positions_and_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Shuffle for getting 15% random tokens for prediction in the masked</span>
    <span class="c1"># language modeling task</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">candidate_pred_positions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mlm_pred_position</span> <span class="ow">in</span> <span class="n">candidate_pred_positions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_positions_and_labels</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_mlm_preds</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">masked_token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 80% of the time: replace the word with the '&lt;mask&gt;' token</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">masked_token</span> <span class="o">=</span> <span class="s1">'&lt;mask&gt;'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 10% of the time: keep the word unchanged</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">masked_token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">mlm_pred_position</span><span class="p">]</span>
            <span class="c1"># 10% of the time: replace the word with a random word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masked_token</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mlm_input_tokens</span><span class="p">[</span><span class="n">mlm_pred_position</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_token</span>
        <span class="n">pred_positions_and_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mlm_pred_position</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="n">mlm_pred_position</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">mlm_input_tokens</span><span class="p">,</span> <span class="n">pred_positions_and_labels</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">def</span> <span class="nf">_get_mlm_data_from_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="n">candidate_pred_positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># `tokens` is a list of strings</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="c1"># Special tokens are not predicted in the masked language modeling</span>
        <span class="c1"># task</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'&lt;cls&gt;'</span><span class="p">,</span> <span class="s1">'&lt;sep&gt;'</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">candidate_pred_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># 15% of random tokens are predicted in the masked language modeling task</span>
    <span class="n">num_mlm_preds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">))</span>
    <span class="n">mlm_input_tokens</span><span class="p">,</span> <span class="n">pred_positions_and_labels</span> <span class="o">=</span> <span class="n">_replace_mlm_tokens</span><span class="p">(</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">candidate_pred_positions</span><span class="p">,</span> <span class="n">num_mlm_preds</span><span class="p">,</span> <span class="n">vocab</span><span class="p">)</span>
    <span class="n">pred_positions_and_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_positions_and_labels</span><span class="p">,</span>
                                       <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pred_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pred_positions_and_labels</span><span class="p">]</span>
    <span class="n">mlm_pred_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pred_positions_and_labels</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">vocab</span><span class="p">[</span><span class="n">mlm_input_tokens</span><span class="p">],</span> <span class="n">pred_positions</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="n">mlm_pred_labels</span><span class="p">]</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">def</span> <span class="nf">_pad_bert_inputs</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="n">max_num_mlm_preds</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">max_len</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">)</span>
    <span class="n">all_token_ids</span><span class="p">,</span> <span class="n">all_segments</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">,</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">all_pred_positions</span><span class="p">,</span> <span class="n">all_mlm_weights</span><span class="p">,</span> <span class="n">all_mlm_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">nsp_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">pred_positions</span><span class="p">,</span> <span class="n">mlm_pred_label_ids</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span>
         <span class="n">is_next</span><span class="p">)</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">all_token_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">token_ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span>
        <span class="n">all_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">segments</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)),</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span>
        <span class="c1"># `valid_lens` excludes count of '&lt;pad&gt;' tokens</span>
        <span class="n">valid_lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">all_pred_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">pred_positions</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                <span class="p">(</span><span class="n">max_num_mlm_preds</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_positions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span>
        <span class="c1"># Predictions of padded tokens will be filtered out in the loss via</span>
        <span class="c1"># multiplication of 0 weights</span>
        <span class="n">all_mlm_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlm_pred_label_ids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span>
                         <span class="p">(</span><span class="n">max_num_mlm_preds</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_positions</span><span class="p">)),</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">all_mlm_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">mlm_pred_label_ids</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                <span class="p">(</span><span class="n">max_num_mlm_preds</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlm_pred_label_ids</span><span class="p">)),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span>
        <span class="n">nsp_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">is_next</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">all_token_ids</span><span class="p">,</span> <span class="n">all_segments</span><span class="p">,</span> <span class="n">valid_lens</span><span class="p">,</span> <span class="n">all_pred_positions</span><span class="p">,</span>
            <span class="n">all_mlm_weights</span><span class="p">,</span> <span class="n">all_mlm_labels</span><span class="p">,</span> <span class="n">nsp_labels</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<span class="k">class</span> <span class="nc">_WikiTextDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paragraphs</span><span class="p">,</span> <span class="n">max_len</span><span class="p">):</span>
        <span class="c1"># Input `paragraphs[i]` is a list of sentence strings representing a</span>
        <span class="c1"># paragraph; while output `paragraphs[i]` is a list of sentences</span>
        <span class="c1"># representing a paragraph, where each sentence is a list of tokens</span>
        <span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">d2l</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">paragraph</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">'word'</span><span class="p">)</span> <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">]</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">sentence</span> <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">paragraph</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span>
            <span class="n">sentences</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">reserved_tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">,</span> <span class="s1">'&lt;mask&gt;'</span><span class="p">,</span> <span class="s1">'&lt;cls&gt;'</span><span class="p">,</span> <span class="s1">'&lt;sep&gt;'</span><span class="p">])</span>
        <span class="c1"># Get data for the next sentence prediction task</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">:</span>
            <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">_get_nsp_data_from_paragraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">,</span> <span class="n">paragraphs</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span>
        <span class="c1"># Get data for the masked language model task</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_get_mlm_data_from_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">+</span>
                     <span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">is_next</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">is_next</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">]</span>
        <span class="c1"># Pad inputs</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_token_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_segments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_lens</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">all_pred_positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_mlm_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_mlm_labels</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">nsp_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">_pad_bert_inputs</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_token_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_segments</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_lens</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_pred_positions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_mlm_weights</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_mlm_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nsp_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_token_ids</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-dataset.md</span>
<div class="viewcode-block" id="load_data_wiki"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_wiki">[docs]</a><span class="k">def</span> <span class="nf">load_data_wiki</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">):</span>
    <span class="sd">"""Load the WikiText-2 dataset."""</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_dataloader_workers</span><span class="p">()</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'wikitext-2'</span><span class="p">,</span> <span class="s1">'wikitext-2'</span><span class="p">)</span>
    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">_read_wiki</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">_WikiTextDataset</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">train_set</span><span class="o">.</span><span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-pretraining/bert-pretraining.md</span>
<span class="k">def</span> <span class="nf">_get_batch_loss_bert</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">tokens_X</span><span class="p">,</span> <span class="n">segments_X</span><span class="p">,</span>
                         <span class="n">valid_lens_x</span><span class="p">,</span> <span class="n">pred_positions_X</span><span class="p">,</span> <span class="n">mlm_weights_X</span><span class="p">,</span> <span class="n">mlm_Y</span><span class="p">,</span>
                         <span class="n">nsp_y</span><span class="p">):</span>
    <span class="c1"># Forward pass</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">mlm_Y_hat</span><span class="p">,</span> <span class="n">nsp_Y_hat</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">tokens_X</span><span class="p">,</span> <span class="n">segments_X</span><span class="p">,</span>
                                  <span class="n">valid_lens_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">pred_positions_X</span><span class="p">)</span>
    <span class="c1"># Compute masked language model loss</span>
    <span class="n">mlm_l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">mlm_Y_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">),</span> <span class="n">mlm_Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span>\
    <span class="n">mlm_weights_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mlm_l</span> <span class="o">=</span> <span class="n">mlm_l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">mlm_weights_X</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="c1"># Compute next sentence prediction loss</span>
    <span class="n">nsp_l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">nsp_Y_hat</span><span class="p">,</span> <span class="n">nsp_y</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">mlm_l</span> <span class="o">+</span> <span class="n">nsp_l</span>
    <span class="k">return</span> <span class="n">mlm_l</span><span class="p">,</span> <span class="n">nsp_l</span><span class="p">,</span> <span class="n">l</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/sentiment-analysis-and-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'aclImdb'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'http://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz'</span><span class="p">,</span>
    <span class="s1">'01ada507287d82875905620988597833ad4e0903'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/sentiment-analysis-and-dataset.md</span>
<div class="viewcode-block" id="read_imdb"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_imdb">[docs]</a><span class="k">def</span> <span class="nf">read_imdb</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">is_train</span><span class="p">):</span>
    <span class="sd">"""Read the IMDb review dataset text sequences and labels."""</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'pos'</span><span class="p">,</span> <span class="s1">'neg'</span><span class="p">):</span>
        <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">'train'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s1">'test'</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_name</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">review</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">review</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'pos'</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/sentiment-analysis-and-dataset.md</span>
<div class="viewcode-block" id="load_data_imdb"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_imdb">[docs]</a><span class="k">def</span> <span class="nf">load_data_imdb</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">"""Return data iterators and the vocabulary of the IMDb review dataset."""</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'aclImdb'</span><span class="p">,</span> <span class="s1">'aclImdb'</span><span class="p">)</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">train_tokens</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">token</span><span class="o">=</span><span class="s1">'word'</span><span class="p">)</span>
    <span class="n">test_tokens</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">token</span><span class="o">=</span><span class="s1">'word'</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span><span class="n">train_tokens</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">train_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
        <span class="n">d2l</span><span class="o">.</span><span class="n">truncate_pad</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">train_tokens</span><span class="p">])</span>
    <span class="n">test_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
        <span class="n">d2l</span><span class="o">.</span><span class="n">truncate_pad</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">test_tokens</span><span class="p">])</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">load_array</span><span class="p">((</span><span class="n">train_features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                                <span class="n">batch_size</span><span class="p">)</span>
    <span class="n">test_iter</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">load_array</span><span class="p">((</span><span class="n">test_features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                               <span class="n">batch_size</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/sentiment-analysis-rnn.md</span>
<div class="viewcode-block" id="predict_sentiment"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.predict_sentiment">[docs]</a><span class="k">def</span> <span class="nf">predict_sentiment</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
    <span class="sd">"""Predict the sentiment of a text sequence."""</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">sequence</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="n">device</span><span class="o">=</span><span class="n">d2l</span><span class="o">.</span><span class="n">try_gpu</span><span class="p">())</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'positive'</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">'negative'</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/natural-language-inference-and-dataset.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'SNLI'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'https://nlp.stanford.edu/projects/snli/snli_1.0.zip'</span><span class="p">,</span>
                        <span class="s1">'9fcde07509c7e87ec61c640c1b2753d9041758e4'</span><span class="p">)</span>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/natural-language-inference-and-dataset.md</span>
<div class="viewcode-block" id="read_snli"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.read_snli">[docs]</a><span class="k">def</span> <span class="nf">read_snli</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">is_train</span><span class="p">):</span>
    <span class="sd">"""Read the SNLI dataset into premises, hypotheses, and labels."""</span>
    <span class="k">def</span> <span class="nf">extract_text</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Remove information that will not be used by us</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">('</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">)'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="c1"># Substitute two or more consecutive whitespace with space</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">s{2,}'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">label_set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'entailment'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'contradiction'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'neutral'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="p">,</span> <span class="s1">'snli_1.0_train.txt'</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s1">'snli_1.0_test.txt'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">premises</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">label_set</span><span class="p">]</span>
    <span class="n">hypotheses</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">label_set</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_set</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">label_set</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">premises</span><span class="p">,</span> <span class="n">hypotheses</span><span class="p">,</span> <span class="n">labels</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/natural-language-inference-and-dataset.md</span>
<div class="viewcode-block" id="SNLIDataset"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.SNLIDataset">[docs]</a><span class="k">class</span> <span class="nc">SNLIDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">"""A customized dataset to load the SNLI dataset."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span> <span class="o">=</span> <span class="n">num_steps</span>
        <span class="n">all_premise_tokens</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">all_hypothesis_tokens</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vocab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">Vocab</span><span class="p">(</span><span class="n">all_premise_tokens</span> <span class="o">+</span> <span class="n">all_hypothesis_tokens</span><span class="p">,</span>
                                   <span class="n">min_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">reserved_tokens</span><span class="o">=</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premises</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad</span><span class="p">(</span><span class="n">all_premise_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad</span><span class="p">(</span><span class="n">all_hypothesis_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'read '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">premises</span><span class="p">))</span> <span class="o">+</span> <span class="s1">' examples'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
            <span class="n">d2l</span><span class="o">.</span><span class="n">truncate_pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_steps</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;pad&gt;'</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">premises</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">premises</span><span class="p">)</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/natural-language-inference-and-dataset.md</span>
<div class="viewcode-block" id="load_data_snli"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.load_data_snli">[docs]</a><span class="k">def</span> <span class="nf">load_data_snli</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">"""Download the SNLI dataset and return data iterators and vocabulary."""</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_dataloader_workers</span><span class="p">()</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">download_extract</span><span class="p">(</span><span class="s1">'SNLI'</span><span class="p">)</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">read_snli</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">read_snli</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">SNLIDataset</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">test_set</span> <span class="o">=</span> <span class="n">SNLIDataset</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">train_set</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="n">test_iter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">train_set</span><span class="o">.</span><span class="n">vocab</span></div>


<span class="c1"># Defined in file: ./chapter_natural-language-processing-applications/natural-language-inference-attention.md</span>
<div class="viewcode-block" id="predict_snli"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.predict_snli">[docs]</a><span class="k">def</span> <span class="nf">predict_snli</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">premise</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">):</span>
    <span class="sd">"""Predict the logical relationship between the premise and hypothesis."""</span>
    <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">premise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">premise</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">d2l</span><span class="o">.</span><span class="n">try_gpu</span><span class="p">())</span>
    <span class="n">hypothesis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="n">hypothesis</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">d2l</span><span class="o">.</span><span class="n">try_gpu</span><span class="p">())</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">net</span><span class="p">([</span><span class="n">premise</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
             <span class="n">hypothesis</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'entailment'</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">'contradiction'</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">1</span> \
            <span class="k">else</span> <span class="s1">'neutral'</span></div>


<span class="c1"># Defined in file: ./chapter_generative-adversarial-networks/gan.md</span>
<div class="viewcode-block" id="update_D"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.update_D">[docs]</a><span class="k">def</span> <span class="nf">update_D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">net_D</span><span class="p">,</span> <span class="n">net_G</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">trainer_D</span><span class="p">):</span>
    <span class="sd">"""Update discriminator."""</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">trainer_D</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">real_Y</span> <span class="o">=</span> <span class="n">net_D</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">fake_X</span> <span class="o">=</span> <span class="n">net_G</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="c1"># Do not need to compute gradient for `net_G`, detach it from</span>
    <span class="c1"># computing gradients.</span>
    <span class="n">fake_Y</span> <span class="o">=</span> <span class="n">net_D</span><span class="p">(</span><span class="n">fake_X</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="n">loss_D</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss</span><span class="p">(</span><span class="n">real_Y</span><span class="p">,</span> <span class="n">ones</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">real_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span>
              <span class="n">loss</span><span class="p">(</span><span class="n">fake_Y</span><span class="p">,</span> <span class="n">zeros</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fake_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">loss_D</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">trainer_D</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss_D</span></div>


<span class="c1"># Defined in file: ./chapter_generative-adversarial-networks/gan.md</span>
<div class="viewcode-block" id="update_G"><a class="viewcode-back" href="https://d2l.ai/chapter_appendix-tools-for-deep-learning/d2l.html#d2l.torch.update_G">[docs]</a><span class="k">def</span> <span class="nf">update_G</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">net_D</span><span class="p">,</span> <span class="n">net_G</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">trainer_G</span><span class="p">):</span>
    <span class="sd">"""Update generator."""</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">trainer_G</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="c1"># We could reuse `fake_X` from `update_D` to save computation</span>
    <span class="n">fake_X</span> <span class="o">=</span> <span class="n">net_G</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="c1"># Recomputing `fake_Y` is needed since `net_D` is changed</span>
    <span class="n">fake_Y</span> <span class="o">=</span> <span class="n">net_D</span><span class="p">(</span><span class="n">fake_X</span><span class="p">)</span>
    <span class="n">loss_G</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">fake_Y</span><span class="p">,</span> <span class="n">ones</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fake_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">loss_G</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">trainer_G</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss_G</span></div>


<span class="c1"># Defined in file: ./chapter_generative-adversarial-networks/dcgan.md</span>
<span class="n">d2l</span><span class="o">.</span><span class="n">DATA_HUB</span><span class="p">[</span><span class="s1">'pokemon'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2l</span><span class="o">.</span><span class="n">DATA_URL</span> <span class="o">+</span> <span class="s1">'pokemon.zip'</span><span class="p">,</span>
                           <span class="s1">'c065c0e2593b8b161a2d7873e42418bf6a21106c'</span><span class="p">)</span>


<span class="c1"># Alias defined in config.ini</span>


<span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span>
<span class="n">arange</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span>
<span class="n">meshgrid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span>
<span class="n">sin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span>
<span class="n">sinh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sinh</span>
<span class="n">cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span>
<span class="n">cosh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cosh</span>
<span class="n">tanh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span>
<span class="n">linspace</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span>
<span class="n">normal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span>
<span class="n">matmul</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span>
<span class="n">int32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">int32</span>
<span class="n">float32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
<span class="n">concat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span>
<span class="nb">abs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span>
<span class="n">eye</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span>
<span class="n">numpy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">numel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">reshape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">to</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">reduce_sum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">argmax</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">astype</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">transpose</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</pre></div>

        </div>
        <div class="side-doc-outline">
            <div class="side-doc-outline--content" style="height: 597.8px;"> 
            </div>
        </div>

      <div class="clearer"></div>
    </div><div class="pagenation">
  </div>
        
        </main>
    <div class="mdl-layout__obfuscator"></div></div></div>
  
</body></html>